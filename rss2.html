<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>JoelYing</title>
    <link>https://joelying.github.io/</link>
    <atom:link href="/rss2.html" rel="self" type="application/rss+xml"/>
    
    <description>半个兴趣使然的程序员</description>
    <pubDate>Thu, 06 Feb 2020 10:21:43 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>Django搭建免费视频网站其三</title>
      <link>https://joelying.github.io/post/f3026717.html</link>
      <guid>https://joelying.github.io/post/f3026717.html</guid>
      <pubDate>Thu, 06 Feb 2020 08:04:20 GMT</pubDate>
      <description>
      
        情，心中青梅，年老仍记年少涩
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Thu Feb 06 2020 18:23:34 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_8.jpg"><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><a href="https://github.com/joelYing/LVideo" target="_blank" rel="noopener">代码传送门</a></p><h3 id="登录注册功能"><a href="#登录注册功能" class="headerlink" title="登录注册功能"></a>登录注册功能</h3><p>在base.html中挖个block：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> login-register %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>在需要的页面上填补</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block login-register %&#125;</span><br><span class="line">    &#123;% if request.session.is_login %&#125;</span><br><span class="line">        &#123;% include "video/user_model.html" %&#125;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        &#123;% include "video/model.html" %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>包含登录注册的按钮</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav navbar-right"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span> <span class="attr">id</span>=<span class="string">"register-btn"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#register"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>&amp;nbsp;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span> <span class="attr">id</span>=<span class="string">"login-btn"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#login"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 注册窗口 --&gt;</span></span><br><span class="line">&#123;% include 'video/register.html' %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 登录窗口 --&gt;</span></span><br><span class="line">&#123;% include 'video/login.html' %&#125;</span><br></pre></td></tr></table></figure><p>登录注册，我采用的是bootstrap的模态框modal</p><p>登录部分：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"login"</span> <span class="attr">class</span>=<span class="string">"modal fade"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content l-register-login"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"close l-register-login"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&amp;times;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-title"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                # 模态框的主体form部分</span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-group"</span> <span class="attr">id</span>=<span class="string">"loginform"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    &#123;% csrf_token %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"l-username"</span> <span class="attr">placeholder</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-left"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"alert-warning"</span> <span class="attr">id</span>=<span class="string">"login-info"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-right"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"loginbtn"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#register"</span>&gt;</span>还没有账号？点我注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">                &#123;#const token = $('input[name=csrfmiddlewaretoken]').val();#&#125;</span><br><span class="line"><span class="javascript">                $(<span class="string">"#loginbtn"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    $.ajax(&#123;</span></span><br><span class="line">                        &#123;#cache:false,#&#125;</span><br><span class="line"><span class="actionscript">                        type:<span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">                        url:<span class="string">"/login"</span>,</span></span><br><span class="line"><span class="actionscript">                        dataType:<span class="string">'json'</span>,</span></span><br><span class="line">                        data:&#123;</span><br><span class="line"><span class="actionscript">                            <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">"username"</span>: $(<span class="string">"#l-username"</span>).val(),</span></span><br><span class="line"><span class="javascript">                            <span class="string">"password"</span>: $(<span class="string">"#password"</span>).val(),</span></span><br><span class="line">                        &#125;,</span><br><span class="line"><span class="actionscript">                        <span class="comment">//通过id找到提交form表单，并将表单转成字符串</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">async</span>:<span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">//异步为真，ajax提交的过程中，同时可以做其他的操作</span></span></span><br><span class="line"><span class="actionscript">                        success:<span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//jquery3以后，会将回传过来的字符串格式的data自动json解析不用再使用一遍JSON.parse(data)了，不然反而会在控制台报错</span></span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">if</span>(data.status===<span class="string">"success"</span>) &#123;</span></span><br><span class="line">                                &#123;#$("#login-info").text(data.msg);#&#125;</span><br><span class="line">                                &#123;#$('#login').modal('hide');#&#125;</span><br><span class="line"><span class="javascript">                                <span class="built_in">window</span>.location.reload();</span></span><br><span class="line">                            &#125;</span><br><span class="line"><span class="actionscript">                            <span class="keyword">else</span> <span class="keyword">if</span>(data.status===<span class="string">"fail"</span>)&#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#login-info'</span>).text(data.msg);</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            &#123;#console.log(data);#&#125;</span><br><span class="line">                            &#123;#console.log(data.status);#&#125;</span><br><span class="line">                            &#123;#console.log(data.message);#&#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line"><span class="actionscript">                <span class="comment">//如果显示了错误信息，修改输入框内容，错误信息隐藏</span></span></span><br><span class="line"><span class="javascript">                $(<span class="string">"input"</span>).bind(<span class="string">'input propertychange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#login-info'</span>).html(<span class="string">''</span>);</span></span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>登录部分逻辑：</p><p>通过ajax提交登录的用户名以及密码，视图层对接收到的用户名密码进行校验，若成功则返回登录成功的信息，并设置session，传回来的信息若成功则会刷新当前页面，同时判断session中<code>is_login</code>是否为True，若为True，则登录注册按钮替换为用户名和注销按钮</p><p>注意点：</p><p>通过ajax给弹出来的模态框中的登录提交按钮添加点击事件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type:<span class="string">"POST"</span>,           <span class="comment">// 请求类型</span></span><br><span class="line">    url:<span class="string">"/login"</span>,          <span class="comment">// 请求的路径</span></span><br><span class="line">    dataType:<span class="string">'json'</span>,       <span class="comment">// 数据格式</span></span><br><span class="line">    data:&#123;</span><br><span class="line">        <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,  <span class="comment">// 避免提交时Forbidden (CSRF token missing or incorrect.)</span></span><br><span class="line">        <span class="string">"username"</span>: $(<span class="string">"#l-username"</span>).val(),         <span class="comment">// 注意取值时用 val()</span></span><br><span class="line">        <span class="string">"password"</span>: $(<span class="string">"#password"</span>).val(),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span>:<span class="literal">true</span>,                                     <span class="comment">// 异步为真，ajax提交的过程中，同时可以做其他的操作</span></span><br><span class="line">    success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//jquery3以后，会将回传过来的字符串格式的data自动json解析不用再使用一遍JSON.parse(data)了，不然反而会在控制台报错</span></span><br><span class="line">        <span class="keyword">if</span>(data.status===<span class="string">"success"</span>) &#123;</span><br><span class="line">            <span class="built_in">window</span>.location.reload();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(data.status===<span class="string">"fail"</span>)&#123;              <span class="comment">// 若返回的信息中 status为fail ，则打印msg</span></span><br><span class="line">            $(<span class="string">'#login-info'</span>).text(data.msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>登录部分视图层逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span> <span class="keyword">and</span> request.POST:</span><br><span class="line">        data = request.POST</span><br><span class="line">        username = data.get(<span class="string">"username"</span>)</span><br><span class="line">        password = data.get(<span class="string">"password"</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">and</span> password:</span><br><span class="line">            custom = Custom.objects.filter(username=username).first()</span><br><span class="line">            <span class="keyword">if</span> custom:</span><br><span class="line">                now_password = Custom.md5_pwd(password)</span><br><span class="line">                db_password = custom.password</span><br><span class="line">                <span class="keyword">if</span> now_password == db_password:</span><br><span class="line">                    response = JsonResponse(&#123;<span class="string">"status"</span>: <span class="string">"success"</span>, <span class="string">"msg"</span>: <span class="string">"登录成功"</span>&#125;)</span><br><span class="line">                    <span class="comment"># response.set_cookie('username', username, max_age=7 * 24 * 3600)</span></span><br><span class="line">                    <span class="comment"># response.set_cookie('password', password, max_age=7 * 24 * 3600)</span></span><br><span class="line">                    <span class="comment"># 通过session识别用户并保持用户状态</span></span><br><span class="line">                    request.session[<span class="string">'is_login'</span>] = <span class="literal">True</span></span><br><span class="line">                    request.session[<span class="string">'username'</span>] = username</span><br><span class="line">                    <span class="keyword">return</span> response</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "密码错误"&#125;'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户不存在"&#125;'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户名或密码为空"&#125;'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "请求失败"&#125;'</span>)</span><br></pre></td></tr></table></figure><p>注意HttpResponse与JsonResponse使用时的差别！！！</p><p>登陆成功后刷新页面过程会判断session.is_login，若是True，就显示<code>video/user_model.html</code>中的用户名及注销按钮：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> login-register %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.session.is_login %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> "video/user_model.html" %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> "video/model.html" %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>注册视图层逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span> <span class="keyword">and</span> request.POST:</span><br><span class="line">        data = request.POST</span><br><span class="line">        username = data.get(<span class="string">"username"</span>)</span><br><span class="line">        email = data.get(<span class="string">"email"</span>)</span><br><span class="line">        password1 = data.get(<span class="string">"password1"</span>)</span><br><span class="line">        password2 = data.get(<span class="string">"password2"</span>)</span><br><span class="line">        custom = Custom.objects.filter(username=username)</span><br><span class="line">        custom_email = Custom.objects.filter(email=email)</span><br><span class="line">        <span class="keyword">if</span> custom:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户名已存在，请重新输入"&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> password1 != password2:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "亲~两次密码输入不一致，请重新输入"&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> custom_email:  <span class="comment"># 邮箱地址唯一</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "该邮箱已注册，请换一个邮箱"&#125;'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 注册成功，创建用户</span></span><br><span class="line">            Custom.objects.create(</span><br><span class="line">                username=username,</span><br><span class="line">                email=email,</span><br><span class="line">                password=Custom.md5_pwd(password1),</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 重定向到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "success", "msg": "注册成功"&#125;'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "请求失败"&#125;'</span>)</span><br></pre></td></tr></table></figure><p>注销视图层逻辑：</p><p>点击注销按钮，如果拿到<code>is_login</code>的值为True，那么刷新session，清除了用户的登录状态，然后重定向回index页面，重定向过程判断<code>is_login</code>值不存在，就会显示登录注册的按钮</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.session.get(<span class="string">'is_login'</span>):</span><br><span class="line">        request.session.flush()</span><br><span class="line">        <span class="comment"># flush会一次性清空session中所有内容，可以使用下面的方法</span></span><br><span class="line">        <span class="comment"># del request.session['is_login']</span></span><br><span class="line">        <span class="comment"># del request.session['user_id']</span></span><br><span class="line">        <span class="comment"># del request.session['user_name']</span></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"index"</span>)</span><br></pre></td></tr></table></figure><h3 id="ajax"><a href="#ajax" class="headerlink" title="ajax"></a>ajax</h3><p>ajax传的数据格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data:&#123;</span><br><span class="line">    <span class="string">"name"</span>: $(<span class="string">"#id_name"</span>).val(),      <span class="comment">// 在"#"号后面是控件id， 所以千万不要搞错了，要不然会出大事的</span></span><br><span class="line">    <span class="string">"limit"</span>: $(<span class="string">"#id_limit"</span>).val(),</span><br><span class="line">    <span class="string">"address"</span>: $(<span class="string">"#id_address"</span>).val(),</span><br><span class="line">    <span class="string">"start_time"</span>: $(<span class="string">"#id_start_time"</span>).val(),</span><br><span class="line">    <span class="string">"status"</span>: $(<span class="string">"#id_status"</span>).val(),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>view层返回到ajax的数据应该如以下类型：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ return HttpResponse('&#123;"status": "success", "msg": "登录成功"&#125;')</span></span><br></pre></td></tr></table></figure><p>而不是</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- return HttpResponse('&#123;"status": "success"&#125;, &#123;"msg": "登录成功"&#125;')</span></span><br></pre></td></tr></table></figure><p>ajax实现发送post请求到服务器并返回结果信息到HTML页面主要逻辑参考：<br><a href="https://cloud.tencent.com/developer/article/1145518" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1145518</a><br><a href="https://blog.csdn.net/Jayden_Gu/article/details/82386565" target="_blank" rel="noopener">https://blog.csdn.net/Jayden_Gu/article/details/82386565</a></p><p>用ajax实现点击登录弹出对话框登陆，成功后页面不刷新，修改登录为用户名：</p><p><a href="https://www.cnblogs.com/chenxi188/p/12176700.html" target="_blank" rel="noopener">Cookie版参考</a></p><p>ajax发送请求后，在views中，若成功登录的条件符合，接下来就添加给response添加set_cookie为username，这样一来request中就保留了cookie的信息，而再通过判断取得cookie中的username，若为空则用户未登录，若有值则将这个值传入模板中渲染即可</p><p><a href="https://www.jianshu.com/p/4f84d0e0c8c9" target="_blank" rel="noopener">session版参考</a></p><p>解决注销，session保持会话状态的问题，Django的模板中可以直接引用request.session</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_44239541/article/details/89055637" target="_blank" rel="noopener">基础功能逻辑</a><br><a href="https://blog.csdn.net/u012561176/article/details/84552532" target="_blank" rel="noopener">表单提交</a><br><a href="https://blog.csdn.net/qq_26421325/article/details/44153039" target="_blank" rel="noopener">消息提示</a><br><a href="https://blog.csdn.net/miaoqinian/article/details/80668003" target="_blank" rel="noopener">HttpResponse、render,、redirect</a><br><a href="https://www.jianshu.com/p/4ffd7184b611" target="_blank" rel="noopener">注册登录弹出模态框</a><br><a href="https://www.cnblogs.com/iqian/p/5784972.html" target="_blank" rel="noopener">ajax格式</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://joelying.github.io/post/f3026717.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Pyqt5实现一个小项目的界面</title>
      <link>https://joelying.github.io/post/8d24b1e6.html</link>
      <guid>https://joelying.github.io/post/8d24b1e6.html</guid>
      <pubDate>Wed, 05 Feb 2020 14:28:46 GMT</pubDate>
      <description>
      
        天上剑仙三百万，遇我也需尽低眉
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Thu Feb 06 2020 18:23:35 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_3.jpg"><a id="more"></a><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装Pyqt5</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyqt5 -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><p>安装Qtcreator，<a href="http://download.qt.io/official_releases/qtcreator/" target="_blank" rel="noopener">地址</a></p><h2 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h2><p>新建参考：<a href="https://www.jianshu.com/p/3be3bfcdd62e" target="_blank" rel="noopener">https://www.jianshu.com/p/3be3bfcdd62e</a></p><p>结果</p><p><img src="http://image.joelyings.com/2020-02-06_1.png" alt></p><h2 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h2><p>将.ui的文件转换为.py的文件，cmd命令进入.ui文件所在目录下，运行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyuic5 -o xxx.py xxx.ui</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_41929524/article/details/81456308" target="_blank" rel="noopener">Python制作小软件——1. 安装并使用PyQt5进行界面设计</a><br><a href="https://www.cnblogs.com/chen0307/p/9844352.html" target="_blank" rel="noopener">python使用PyQt5，及QtCreator，qt-unified界面设计以及逻辑实现</a><br><a href="https://www.cnblogs.com/linyfeng/category/1546338.html" target="_blank" rel="noopener">随笔分类 - PyQt入门教程</a><br><a href="https://blog.csdn.net/weixin_41929524/article/details/81484806" target="_blank" rel="noopener">Python制作小软件——4. 利用PyInstaller打包成exe文件</a><br><a href="https://blog.csdn.net/bailang_zhizun/article/details/79310419" target="_blank" rel="noopener">Python - 编写可视化界面（Python+PyCharm+PyQt）</a><br><a href></a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://joelying.github.io/post/8d24b1e6.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Django搭建免费视频网站其二</title>
      <link>https://joelying.github.io/post/b15ef11a.html</link>
      <guid>https://joelying.github.io/post/b15ef11a.html</guid>
      <pubDate>Wed, 05 Feb 2020 14:27:25 GMT</pubDate>
      <description>
      
        易事，难事，风雨事，江湖事，王朝事，天下事，都不过一剑的事
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Thu Feb 06 2020 18:23:34 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_5.jpg"><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><a href="https://github.com/joelYing/LVideo" target="_blank" rel="noopener">代码传送门</a></p><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><h4 id="自定义tag"><a href="#自定义tag" class="headerlink" title="自定义tag"></a>自定义tag</h4><p><span id="inline-purple">自定义tag</span></p><p>这是在练习Django时做的博客项目中用到的，在这里记录，目的是为了把评论功能做成一个即插即用的组件</p><p>用到了Django的template tag（自定义标签）的接口，使得在任何需要添加评论的地方，只要使用</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">comment_block</span> request.path %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>即可，之所以叫comment_block，是因为comment是Django的内置tag，用来做大块代码的注释，类似for循环和if判断，这些都是内置的，所以我们需要自定义一个tag</p><p>在commentAPP下新建templatetags目录，同时新增<code>__init__.py</code>与<code>comment_block.py</code>文件</p><p>在<code>comment_block.py</code>中编写自定义标签的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> comment.forms <span class="keyword">import</span> CommentForm</span><br><span class="line"><span class="keyword">from</span> comment.models <span class="keyword">import</span> Comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register.inclusion_tag('comment/block.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment_block</span><span class="params">(target)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">'target'</span>: target,               <span class="comment"># 评论目标博文的url</span></span><br><span class="line">        <span class="string">'comment_form'</span>: CommentForm(),  <span class="comment"># 评论表单</span></span><br><span class="line">        <span class="string">'comment_list'</span>: Comment.get_by_target(target),  <span class="comment"># 根据博文路径获取的博文下的评论</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>方法会返回以上的内容，包括target(目标文章)，comment_form(评论表单的样式)，comment_list(根据target得到的评论的list)，去渲染 comment/block.html 模板文件</p><figure class="highlight html"><figcaption><span>comment/block.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-group"</span> <span class="attr">action</span>=<span class="string">"/comment/"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"target"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; target &#125;&#125;"</span>&gt;</span></span><br><span class="line">        &#123;&#123; comment_form &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"写好了"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 评论列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">        &#123;% for comment in comment_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"nickname"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; comment.website &#125;&#125;"</span>&gt;</span>&#123;&#123; comment.nickname &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; comment.created_time &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment-content"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 关闭Django模板自动转码功能 ，如不关怎会出现页面上的评论内容是这样的：&lt;p&gt;hahahahahhahahahahahhaha&lt;/p&gt; --&gt;</span></span><br><span class="line">                &#123;% autoescape off %&#125;</span><br><span class="line">                &#123;&#123; comment.content &#125;&#125;</span><br><span class="line">                &#123;% endautoescape %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将value=”中的target渲染好后，带上comment_form参数，文件中的form最后发送一个post请求到/comment/的路由<br>根据url.py中的路由规则，请求得到的闭包发送给CommentView</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    http_method_names = [<span class="string">'post'</span>]</span><br><span class="line">    template_name = <span class="string">'comment/result.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        comment_form = CommentForm(request.POST)</span><br><span class="line">        target = request.POST.get(<span class="string">'target'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> comment_form.is_valid():</span><br><span class="line">            instance = comment_form.save(commit=<span class="literal">False</span>)</span><br><span class="line">            instance.target = target</span><br><span class="line">            instance.save()</span><br><span class="line">            succeed = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> redirect(target)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            succeed = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">'succeed'</span>: succeed,</span><br><span class="line">            <span class="string">'form'</span>: comment_form,</span><br><span class="line">            <span class="string">'target'</span>: target,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> self.render_to_response(context)</span><br></pre></td></tr></table></figure><p>在CommentView中的post方法接收这些参数，验证comment_form，并保存数据到instance，存到数据库中<br>成功后返回</p><p>在博文详情页面加上评论功能：</p><figure class="highlight html"><figcaption><span>detail.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "./base.html" %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 加载自定义的标签 --&gt;</span></span><br><span class="line">&#123;% load comment_block %&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;% block main %&#125;</span><br><span class="line">&#123;% if post %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; post.title &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>分类：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'category-list' post.category_id %&#125;"</span>&gt;</span>&#123;&#123; post.category.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>作者：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'author' post.owner.id %&#125;"</span>&gt;</span>&#123;&#123; post.owner.username &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% autoescape off %&#125;</span><br><span class="line">    &#123;&#123; post.content_html &#125;&#125;</span><br><span class="line">    &#123;% endautoescape %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用标签，传入参数request.path，即target --&gt;</span></span><br><span class="line">&#123;% comment_block request.path %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>Django模板中可以使用<code>request</code>参数，<code>request.path</code>就是当前博文页面的url，将其作为参数传递给自定义的<code>comment_block</code>标签的方法，此时<code>def comment_block(target)</code>中传入的target参数就是<code>request.path</code></p><p>评论表单提交的流程：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">1. 在文章页面下方的表单中(detail.html)页面中，加载</span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> comment_block %&#125;</span><span class="xml"> comment_block标签</span></span><br><span class="line"><span class="xml">2. 引用的时候，</span><span class="template-tag">&#123;% <span class="name">comment_block</span> request.path %&#125;</span><span class="xml">，传入参数request.path，即当前文章所在的url</span></span><br><span class="line"><span class="xml">3. 在comment_block.py中定义了方法，需要传入的参数为target，这样做就使得 target=request.path</span></span><br></pre></td></tr></table></figure><blockquote><p>用户填写评论，提交表单 -&gt; CommentForm处理表单 -&gt; 验证通过 -&gt; 保存数据到instance -&gt; instance.save方法把数据保存到数据库 -&gt; 用户刷新页面 -&gt; 通过comment_block模板自定义标签获取并展示数据</p><footer><strong>Django企业开发实战</strong><cite>胡阳</cite></footer></blockquote><h4 id="spaceless"><a href="#spaceless" class="headerlink" title="spaceless"></a>spaceless</h4><p><span id="inline-purple">spaceless</span></p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">spaceless</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>标签的作用是 去除Django模板因使用for循环而产生的很多空行</p><h4 id="autoescape"><a href="#autoescape" class="headerlink" title="autoescape"></a>autoescape</h4><p><span id="inline-purple">autoescape</span></p><p>作用是关闭Django模板的自动转码功能</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% autoescape off %&#125;</span><br><span class="line">&#123;&#123; post.content_html &#125;&#125;</span><br><span class="line">&#123;% endautoescape %&#125;</span><br></pre></td></tr></table></figure><h4 id="forloop"><a href="#forloop" class="headerlink" title="forloop"></a>forloop</h4><p><a href="https://www.cnblogs.com/chenkeven/articles/9340961.html" target="_blank" rel="noopener">django forloop添加序号和增加一对多数据示例</a></p><h4 id="title属性"><a href="#title属性" class="headerlink" title="title属性"></a>title属性</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rank_text_name"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span>&#123;&#123; video.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为<code>span</code>添加<code>title</code>属性，鼠标移到元素上时显示title中的内容</p><p>避免用户看不到某些视频名称过长而因truncate缩减，导致看不见视频全称的情况</p><h4 id="remark"><a href="#remark" class="headerlink" title="remark"></a>remark</h4><p><a href="https://www.cnblogs.com/Jack1ee/p/5426757.html" target="_blank" rel="noopener">参考这篇</a></p><p>具体内容：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、首先当然是要插入一张图片啦，</span><br><span class="line">代码如下：&lt;<span class="selector-tag">a</span> href=<span class="string">"#"</span> target=<span class="string">"_blank"</span>&gt;&lt;<span class="selector-tag">img</span> src=<span class="string">"images/13.png"</span> <span class="attribute">width</span>=<span class="string">"240"</span> heigth=<span class="string">"240"</span>&gt;&lt;/a&gt;</span><br><span class="line">图片路径自己定义。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、定义一个层在图片上。这里要用到定位。<span class="attribute">position</span>。</span><br><span class="line">&lt;<span class="selector-tag">div</span> class=<span class="string">"con_img"</span>&gt;&lt;<span class="selector-tag">img</span> src=<span class="string">""</span>&gt;&lt;<span class="selector-tag">span</span> class=<span class="string">"ms"</span>&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">.con_img&#123;<span class="attribute">position</span>: relative; <span class="attribute">width</span>: <span class="number">240px</span>; <span class="attribute">height</span>: <span class="number">240px</span>;&#125;</span><br><span class="line">.ms&#123;<span class="attribute">position</span>: absolute; <span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">240px</span>; <span class="attribute">height</span>: <span class="number">25px</span>; <span class="attribute">background</span>: <span class="number">#000</span>;&#125;</span><br></pre></td></tr></table></figure><p>修改如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cover_img_span3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"cover_remark"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.remark &#125;&#125;"</span>&gt;</span>&#123;&#123; video.remark &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"180px"</span> <span class="attr">height</span>=<span class="string">"236px"</span> <span class="attr">class</span>=<span class="string">"type-list-card-img"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; video.cover_url &#125;&#125;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为视频封面右下角添加remark备注</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">css</span>部分</span><br><span class="line"><span class="selector-class">.cover_img_span3</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">194px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">250px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">span</span><span class="selector-class">.cover_remark</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: normal;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span><br><span class="line">    <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">    <span class="attribute">text-align</span>: right;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(0,0,0,0.65);</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span><br><span class="line">    <span class="comment">/* border: 0.5px solid rgba(0.1,0.1,0.1,0.5); */</span></span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">2.5px</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解析接口"><a href="#解析接口" class="headerlink" title="解析接口"></a>解析接口</h4><p>解析接口页面模板主要部分：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "video/base.html" %&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;% block main %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"vip-logo"</span>&gt;</span>VIP视频在线解析<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"parse-search"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"str-post"</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">'&#123;% url '</span><span class="attr">vip-parse</span>' %&#125;'&gt;</span></span><br><span class="line">            &#123;% csrf_token %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input-url"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"请输入播放地址后解析,支持爱奇艺,优酷,土豆等VIP视频播放地址"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-append"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"path"</span> <span class="attr">style</span>=<span class="string">"width: 200px"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"p-selected"</span>&gt;</span></span><br><span class="line">                      &#123;% for parse_interface in parse_interfaces %&#125;</span><br><span class="line">                          <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; parse_interface.parse_url &#125;&#125;"</span>&gt;</span>&#123;&#123; parse_interface.name &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                      &#123;% endfor %&#125;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-auto"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary mb-2"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://image.joelyings.com/2020-01-11-8.gif"</span> <span class="attr">height</span>=<span class="string">"548px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">id</span>=<span class="string">"player"</span> <span class="attr">scrolling</span>=<span class="string">"no"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"html,body"</span>).animate(&#123;</span></span><br><span class="line"><span class="javascript">                scrollTop: $(<span class="string">".parse-search"</span>).offset().top</span></span><br><span class="line">            &#125;, 200);</span><br><span class="line"><span class="javascript">            $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, <span class="built_in">document</span>.getElementById(<span class="string">"p-selected"</span>).value + $(<span class="string">"#input-url"</span>).val());</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>添加了一个select下拉按钮，里面包含从数据库取出来的解析接口url及名称：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"p-selected"</span>&gt;</span></span><br><span class="line">  &#123;% for parse_interface in parse_interfaces %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; parse_interface.parse_url &#125;&#125;"</span>&gt;</span>&#123;&#123; parse_interface.name &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为提交解析的按钮<code>Submit</code>添加<a href="https://www.w3school.com.cn/jquery/event_submit.asp" target="_blank" rel="noopener">jQuery事件</a>，将接口与待解析的链接<a href="http://tool.liumingye.cn/video/js/video.js?0122" target="_blank" rel="noopener">拼接</a>起来</p><p>参考：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"html,body"</span>).animate(&#123;</span><br><span class="line">        scrollTop: $(<span class="string">".search"</span>).offset().top</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, $(<span class="string">".am-selected"</span>).find(<span class="string">'.am-checked'</span>).data(<span class="string">'value'</span>) + $(<span class="string">"#str-post"</span>).serializeArray()[<span class="number">0</span>].value);</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>修改后：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"str-post"</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">'&#123;% url '</span><span class="attr">vip-parse</span>' %&#125;'&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary mb-2"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://image.joelyings.com/2020-01-11-8.gif"</span> <span class="attr">height</span>=<span class="string">"548px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">id</span>=<span class="string">"player"</span> <span class="attr">scrolling</span>=<span class="string">"no"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="comment">// 为id为str-post的表单添加</span></span><br><span class="line">    $(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"html,body"</span>).animate(&#123;</span><br><span class="line">        scrollTop: $(<span class="string">".parse-search"</span>).offset().top</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line">    <span class="comment">// 为iframe修改播放源</span></span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, <span class="built_in">document</span>.getElementById(<span class="string">"p-selected"</span>).value + $(<span class="string">"#input-url"</span>).val());</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><h4 id="datetimefield"><a href="#datetimefield" class="headerlink" title="datetimefield"></a>datetimefield</h4><p><span id="inline-purple">datetimefield</span></p><p>Django中模型的时间字段定义为datetimefield时，爬虫向这个字段插入同样时间格式的str数据时，可以成功</p><p><a href="https://www.jb51.net/article/155630.htm" target="_blank" rel="noopener">如何在Django中添加没有微秒的 DateTimeField 属性详解</a></p><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><h4 id="多个视频类型共用一个视图逻辑"><a href="#多个视频类型共用一个视图逻辑" class="headerlink" title="多个视频类型共用一个视图逻辑"></a>多个视频类型共用一个视图逻辑</h4><p>每个分类的<code>更多</code>页面通过获取请求的url路径最后部分，根据models中对应的类型，通过一个view进行获取不同类型的queryset，这样就不用每一个<code>更多</code>页面都写一个模板，可以共用一个模板，只是传入的queryset会根据请求路径的不同而不同</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型部分</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    TYPE_DM, TYPE_MV, TYPE_TV, TYPE_ZY, TYPE_OT = <span class="string">'动漫'</span>, <span class="string">'电影'</span>, <span class="string">'电视剧'</span>, <span class="string">'综艺'</span>, <span class="string">'其他'</span></span><br><span class="line">    V_TYPE_LIST = &#123;</span><br><span class="line">        <span class="string">'dm'</span>: TYPE_DM,</span><br><span class="line">        <span class="string">'mv'</span>: TYPE_MV,</span><br><span class="line">        <span class="string">'tv'</span>: TYPE_TV,</span><br><span class="line">        <span class="string">'zy'</span>: TYPE_ZY,</span><br><span class="line">        <span class="string">'ot'</span>: TYPE_OT</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># '更多页面'视图</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoreListView</span><span class="params">(CommonListView)</span>:</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br><span class="line">    template_name = <span class="string">'video/more_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data()</span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="comment"># 传入导航菜单对应视频类型的菜单名称</span></span><br><span class="line">            <span class="string">'button'</span>: VideoInfo.V_TYPE_LIST[str(self.request.path).replace(<span class="string">'/'</span>, <span class="string">''</span>)],</span><br><span class="line">            <span class="string">'links'</span>: Links.get_links(),</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 获取请求的路径</span></span><br><span class="line">        request_path = str(self.request.path).replace(<span class="string">'/'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="comment"># 根据模型层定义的字典获取对应的视频类型</span></span><br><span class="line">        v_type = VideoInfo.V_TYPE_LIST[request_path]</span><br><span class="line">        <span class="comment"># 通过模型层的方法获取对应视频类型的信息queryset，并去模板中渲染</span></span><br><span class="line">        queryset = VideoInfo.get_type_video_list(v_type)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br></pre></td></tr></table></figure><h3 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h3><h4 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h4><p><span id="inline-purple">bootstrap</span></p><p><a href="https://v4.bootcss.com/docs/4.3/content/typography/#text-utilities" target="_blank" rel="noopener">text-utilities</a></p><p>对于较长的文本内容，可以通过添加 .text-truncate 类将文本截断并添加省略号。 元素必须是 display: inline-block 或 display: block 类型</p><p><a href="https://v4.bootcss.com/docs/4.3/content/typography/#inline" target="_blank" rel="noopener">inline</a></p><p>在同一行 Remove a list’s bullets and apply some light margin with a combination of two classes, .list-inline and .list-inline-item.</p><p><a href="https://v4.bootcss.com/docs/4.3/utilities/text/#%E6%96%87%E6%9C%AC%E5%AF%B9%E9%BD%90" target="_blank" rel="noopener">文本对齐</a></p><p>使用文本对齐类可以轻松地将文本重新对齐到组件</p><p><a href="https://v4.bootcss.com/docs/4.3/utilities/spacing/" target="_blank" rel="noopener">间距</a></p><p>控制视频封面间距</p><p><a href="https://www.jianshu.com/p/37f6622adb2d" target="_blank" rel="noopener">bootstrap导航条</a></p><p>也就是<ul></ul>标记中所有<a>标记的href属性都失效了，后来也是一顿搜索，发现，bootstrap把href属性当id处理，只链接到当前页面的位置，而外部跳转链接被屏蔽</a></p><h3 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h3><h4 id="在两个site中注册APP"><a href="#在两个site中注册APP" class="headerlink" title="在两个site中注册APP"></a>在两个site中注册APP</h4><p><span id="inline-purple">同时在两个site中注册Post</span></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@admin</span>.register(Post, site=custom_site) # custom_site</span><br><span class="line"><span class="variable">@admin</span>.register(Post)                   # 默认的site</span><br><span class="line">class PostAdmin(BaseOwnerAdmin):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h3 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h3><h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p><a href="https://blog.csdn.net/LingHuChong20/article/details/103017114" target="_blank" rel="noopener">Django 分页 , 只显示最近的几页( 只显示靠近的几页 )</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block paginate %&#125;</span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% for i in page_obj.paginator.page_range %&#125;</span><br><span class="line">                &#123;% if page_obj.number == i %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item active"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>  <span class="attr">class</span>=<span class="string">"page-link"</span> &gt;</span>&#123;&#123; i &#125;&#125; <span class="tag">&lt;<span class="name">span</span>  <span class="attr">class</span>=<span class="string">"sr-only page-link"</span>&gt;</span>(current)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;%  elif  page_obj.number|add:max_left_item_count &gt;= i and  i|add:max_left_item_count  &gt;= page_obj.number  %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; i &#125;&#125;"</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% if page_obj.has_next %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.next_page_number &#125;&#125;"</span>&gt;</span>&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% if  page_obj.paginator.num_pages &gt;  page_obj.number|add:max_left_item_count  %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.paginator.num_pages &#125;&#125;"</span>&gt;</span>&amp;raquo;&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.paginator.num_pages &#125;&#125;"</span>&gt;</span>&amp;raquo;&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="Scrapy连接池"><a href="#Scrapy连接池" class="headerlink" title="Scrapy连接池"></a>Scrapy连接池</h4><p>连接池的作用：</p><p>异步调用<code>do_insert</code>函数，dbpool会选择连接池中的一个连接对象在独立线程中调用<code>insert_db</code>，其中参数item会被传给<code>do_insert</code>的第二个参数，传给<code>do_insert</code>的第一个参数是一个Transaction对象，其接口与Cursor对象类似，可以调用execute方法执行SQL语句，<code>do_insert</code>执行后，连接对象会自动调用commit方法</p><h4 id="pv-uv"><a href="#pv-uv" class="headerlink" title="pv/uv"></a>pv/uv</h4><p>Django的models中添加了pv\uv这两个字段，默认为1，但是运行爬虫时，若没有数据存入这两个字段则会报错，因为其默认是不为空的，将数据库中原本的默认值改为null倒是可以继续爬虫了；</p><p>而为爬虫添加pv uv默认为1的值，存入数据库也没问题，后续两个值的增加也不会对更新语句有反应</p><h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><div class="note danger no-icon"><p>Reverse for 'xxx' with arguments '('',)' not found. 1 pattern(s) tried: ['Category/(?P<category_id>\d+)$']</category_id></p></div><p>主要原因：</p><p>urls里面设置参数的匹配正则是<code>&#39;category/&lt;int:category_id&gt;&#39;</code>，在html文件中做反向解析的时候又没有参数传递过去</p><p>url配置：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">path</span><span class="params">(<span class="string">'category/&lt;int:category_id&gt;'</span>, CategoryView.as_view()</span></span>, name=<span class="string">'category-list'</span>),</span><br></pre></td></tr></table></figure><p>最后发现是在具体的list.html以及detail.html的文件中给分类标签，虽然加上了</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> 'category-list' cate.id %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>但是cate并不是循环中的值，没有类似以下循环</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> cate <span class="keyword">in</span> navs %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">...</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>GET /static/css/bootstrap.css HTTP/1.1 404 1789</p></div><p>原因：</p><p>没有加载static中的css资源，css路径：myblog/themes/bootstrap/static/css/bootstrap.css</p><p>正确操作：</p><p>THEME的值是前面settings.py中定义的’bootstrap’，将<code>templates</code>改为<code>static</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATIC_ROOT = <span class="string">'tmp/static'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os<span class="selector-class">.path</span><span class="selector-class">.join</span>(BASE_DIR, <span class="string">'themes'</span>, THEME, <span class="string">'static'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>之前是templates 所以找不到static文件夹</p><p>然后在模板中加上</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/bootstrap.css' %&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>即可</p><hr><div class="note danger no-icon"><p>AssertionError: Cannot filter a query once a slice has been taken</p></div><p>问题：获取切片后的数据集无法再进行筛选查询！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VideoDetailView(DetailView):</span><br><span class="line">    queryset = VideoInfo.latest_video()</span><br><span class="line">    ...</span><br><span class="line">    pk_url_kwarg = <span class="string">'video_id'</span></span><br></pre></td></tr></table></figure><p><code>latest_video()</code>方法部分如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryset = cls.objects.all().order_by(<span class="string">'-update_time'</span>)[:<span class="number">300</span>]</span><br></pre></td></tr></table></figure><p><code>[:300]</code>进行了切片，相当于已经经过了一次filter，而重写的<code>pk_url_kwarg</code>相当于DetailView的<code>get_object()</code>方法，</p><p>通过指定的参数<code>video_id</code>来filter上面的queryset数据集，而问题就在于已经切片过的数据集不能再进行筛选，所以后来修改</p><p><code>latest_video()</code>方法如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryset = cls.objects.all().order_by(<span class="string">'-update_time'</span>)</span><br></pre></td></tr></table></figure><p>不在模型层对其进行切片操作，可以把切片放在视图层</p><hr><div class="note danger no-icon"><p>搜索关键词得不到相关视频时，出现的页面底部存在空白</p></div><p>修改如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if video_list %&#125;</span><br><span class="line">    &#123;% for video in video_list %&#125;</span><br><span class="line">    ...</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    # 若搜索关键词找不到相关视频</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"none-videolist"</span> <span class="attr">style</span>=<span class="string">"height: 100%;background-color: #202020;block-size: 1000px;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"h5"</span> <span class="attr">style</span>=<span class="string">"text-align: center;"</span>&gt;</span>未找到视频资源<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>条件检索后点击下一页查询条件丢失</p></div><p>情况跟<a href="https://blog.csdn.net/qq_42219101/article/details/96967243" target="_blank" rel="noopener">这个</a>大致相似：</p><p>在执行完搜索之后，然后到搜索结果的下一页的时候，会出现搜索的结果消失，只在地址栏中留下了，而没有关键词</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正常情况</span></span><br><span class="line">127.0.0.1:8000/search?<span class="attribute">keyword</span>=三生&amp;page=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在的问题</span></span><br><span class="line">127.0.0.1:8000/search/?<span class="attribute">page</span>=2</span><br></pre></td></tr></table></figure><p>搜索的结果全部消失</p><p>解决换页搜索失效还可以<a href="https://blog.csdn.net/secowo/article/details/99685726" target="_blank" rel="noopener">通过JavaScript获取当前路径参数</a></p><p>但是最后还是通过修改<code>search_pagination.html</code>，在跳转页码的时候需要把搜索条件拼接到跳转页码的href上</p><figure class="highlight html"><figcaption><span>video/pagination.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 没有通过关键词搜索情况下的分页</span><br><span class="line"></span><br><span class="line">&#123;% block paginate %&#125;</span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            ...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>video/search_pagination.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 关键词搜索后的分页，区别在于 href="?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span><br><span class="line"></span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            ...</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>判断是否有关键词在上下文中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if keyword %&#125;</span><br><span class="line">    &#123;% include "video/search_pagination.html" %&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    &#123;% include "video/pagination.html" %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>搜索视图的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchView</span><span class="params">(CommonListView)</span>:</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br><span class="line">    template_name = <span class="string">'video/more_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data()</span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="string">'keyword'</span>: self.request.GET.get(<span class="string">'keyword'</span>, <span class="string">''</span>),</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        queryset = super().get_queryset()</span><br><span class="line">        keyword = self.request.GET.get(<span class="string">'keyword'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyword:</span><br><span class="line">            <span class="keyword">return</span> queryset</span><br><span class="line">        <span class="keyword">return</span> queryset.filter(Q(name__icontains=keyword) | Q(alias__icontains=keyword))</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>UnorderedObjectListWarning: Pagination may yield inconsistent results with an unordered object_list: xxx QuerySet.</p></div><p>经过搜索是由于： 所得的数据是无效的，故而分页出现错误</p><p>修改方法，在获得的数据之后对所得的数据进行排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lists = Article.objects.filter(</span><br><span class="line">        Q(title__icontains=word) | Q(context__icontains=word)).order_by(<span class="string">'-created_time'</span>)</span><br></pre></td></tr></table></figure><hr><div class="note danger"><p>封面链接是否有效需要在爬虫中就处理完毕，若失效则添加失效的封面链接代替</p></div><hr><div class="note danger no-icon"><p>models文件没什么问题，APP也都注册了，但就是出现No changes detected</p></div><p>models文件没什么问题，APP也都注册了，但修改models文件后再进行<code>makemigrations</code>，就是出现No changes detected</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(LVideo) E:\LVideo&gt;python3 manage.py makemigrations</span><br><span class="line">No changes detected</span><br></pre></td></tr></table></figure><p>于是一个个APP注册，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(LVideo) E:\LVideo&gt;python3 manage.py makemigrations video</span><br><span class="line">Migrations <span class="keyword">for</span> <span class="string">'video'</span>:</span><br><span class="line">  video\migrations\0001_initial.py</span><br><span class="line">    - Create model Source</span><br><span class="line">    - Create model VideoInfo</span><br><span class="line">    - Create model VideoLink</span><br><span class="line">    - Create model VideoPU</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>遇到视频信息中包含韩文的问题</p></div><p>默认爬虫会保存韩文的<code>HTML实体编码 entity code</code>，类似<code>&amp;#44608;&amp;#45824;&amp;#49457;</code>的编码，而不是保存为韩文字</p><p>为了避免这种情况，需要通过Python的html库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content = html.unescape(html_entity)</span><br></pre></td></tr></table></figure><p>保证将要存入的内容转换后再存入数据库</p><hr><div class="note danger no-icon"><p>ajax的post请求，出现Forbidden (CSRF token missing or incorrect.)</p></div><p>ajax 的post请求,Forbidden (CSRF token missing or incorrect.)错误<a href="https://blog.csdn.net/weixin_43790705/article/details/87867172" target="_blank" rel="noopener">解决办法</a>：</p><p>在data中添加{csrfmiddlewaretoken:’‘}</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    ...</span><br><span class="line">    data:&#123;</span><br><span class="line">        <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>或者，参考<a href="https://blog.csdn.net/qq_36963372/article/details/82713044" target="_blank" rel="noopener">这篇</a></p><p>注意是val()</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 这里添加token</span></span><br><span class="line">    <span class="keyword">var</span> token = $(<span class="string">'input[name=csrfmiddlewaretoken]'</span>).val();</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">         ...</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">'&#123;% url '</span><span class="string">' %&#125;'</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            <span class="comment">// 这里加上</span></span><br><span class="line">            data: &#123;<span class="attr">csrfmiddlewaretoken</span>: token&#125;,</span><br><span class="line">            dataType: <span class="string">'json'</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>补充Hexo的一个问题：Nunjucks Error: [Line 35, Column 13] unknown block tag: xxx</p></div><p>在提交有</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">xxx</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>这种格式的文本时，一定要包上三个<code>点号</code>，两边只包上一个点号，会导致报错</p><h3 id="备选"><a href="#备选" class="headerlink" title="备选"></a>备选</h3><h4 id="播放器"><a href="#播放器" class="headerlink" title="播放器"></a>播放器</h4><p><a href="https://github.com/videojs/video.js" target="_blank" rel="noopener">videojs</a><br><a href="https://github.com/sampotts/plyr" target="_blank" rel="noopener">plyr</a><br><a href="https://github.com/bilibili/flv.js" target="_blank" rel="noopener">flv.js</a><br><a href="https://www.iaodun.com/faq/technical/2502.html" target="_blank" rel="noopener">用JW Player,ckplayer,Smartideo搭建视频直播站-支持各大视频网站和rtmp</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://joelying.github.io/post/b15ef11a.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Django合并Scrapy方法</title>
      <link>https://joelying.github.io/post/661146c6.html</link>
      <guid>https://joelying.github.io/post/661146c6.html</guid>
      <pubDate>Wed, 05 Feb 2020 09:59:39 GMT</pubDate>
      <description>
      
        莫笑我渴时无美酒，江湖来做壶
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Thu Feb 06 2020 18:23:33 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_9.jpeg"><a id="more"></a><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>以后可能会用到</p><p><strong>Django合并Scrapy方法</strong></p><p>新建一个Django项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject xxx</span><br></pre></td></tr></table></figure><p>打开新建的django项目，然后新建一个app</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> xxx</span><br><span class="line">python manage.py startapp xxxx</span><br></pre></td></tr></table></figure><p>在django的根目录下，即xxx项目根目录下，创建scrapy项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject xxxxx</span><br><span class="line"><span class="built_in">cd</span> xxxxx</span><br><span class="line">scrapy genspider xxxxx <span class="string">"yyyyy.com"</span></span><br></pre></td></tr></table></figure><p>在scrapy的settings.py文件中添加配置信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import django</span><br><span class="line">os.environ[<span class="string">'DJANGO_SETTINGS_MODULE'</span>] = <span class="string">'xxx.settings'</span></span><br><span class="line">django.setup()</span><br></pre></td></tr></table></figure><p>下载<a href="https://github.com/scrapy-plugins/scrapy-djangoitem" target="_blank" rel="noopener">scrapy-djangoitem</a>工具包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install scrapy-djangoitem</span><br></pre></td></tr></table></figure><p>在scrapy的items.py中编写</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import scrapy</span><br><span class="line">from scrapy_djangoitem import DjangoItem</span><br><span class="line">from xxx.models import xxxx</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">class abcItem(DjangoItem):</span><br><span class="line">    django_model = xxxx</span><br></pre></td></tr></table></figure><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>把scrapy框架，移动到Django框架的目录下，打开scrapy中的setting.py，加上：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(os.path.dirname(os.path.abspath(<span class="string">'.'</span>)))</span><br><span class="line">os.environ[<span class="string">'DJANGO_SETTINGS_MODULE'</span>] = <span class="string">'django项目名.settings'</span></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line">django.setup()</span><br></pre></td></tr></table></figure><p>scrapy中的item.py中引入Django模型类，安装命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scrapy-djangoitem</span><br></pre></td></tr></table></figure><p>然后在item中加入Django的模型类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy_djangoitem <span class="keyword">import</span> DjangoItem</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> models</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeoItem</span> <span class="params">(DjangoItem)</span>:</span></span><br><span class="line">    <span class="comment"># 此处必须起名为django_model,主爬虫中使用item['title']=xxx</span></span><br><span class="line">    django_model = models.AbckgModel</span><br></pre></td></tr></table></figure><p>在scrapy的 pipelines.py中调用save()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeoPipeline</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        <span class="comment"># 插入到数据库</span></span><br><span class="line">        item.save()</span><br><span class="line">        <span class="keyword">return</span>  item <span class="comment">#将item传给下一个管道继续处理</span></span><br></pre></td></tr></table></figure><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://joelying.github.io/post/661146c6.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Django搭建免费视频网站其一</title>
      <link>https://joelying.github.io/post/8adedfb3.html</link>
      <guid>https://joelying.github.io/post/8adedfb3.html</guid>
      <pubDate>Wed, 05 Feb 2020 06:05:11 GMT</pubDate>
      <description>
      
        世间文字八万个，唯有情字最杀人
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Thu Feb 06 2020 18:23:34 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_2.jpg"><a id="more"></a><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很早就有一个自己做一个免费视频网站的想法，跟<a href="https://www.agefans.tv/" target="_blank" rel="noopener">AGE动漫网</a>那样，不用开会员，不用等广告该有多好…这不在学Django，所以就打算用Django搭建一个这么样的网站</p><p>那么网站的资源怎么来呢？鉴于有很多的视频资源网，比如<a href="http://www.kuyunzy.tv/" target="_blank" rel="noopener">这个</a>，或者<a href="http://www.okzyw.com/" target="_blank" rel="noopener">这个</a>，那么我的初步想法就是写一个爬虫，爬取资源网站的所有视频链接，信息等，再通过Django从数据库中取出这些数据并展示在网站，视频链接还需要每天定时爬取更新</p><p>这样一来，就实现了这个网站的基本功能</p><p>爬虫是通过scrapy框架写的，没什么太大问题，而且本身这些资源网就有配套的建站CMS可以套用，所以这些网站的页面结构也相对简单</p><p>所以主要来讲讲这里Django的应用</p><p><a href="https://github.com/joelYing/LVideo" target="_blank" rel="noopener">代码传送门</a></p><h2 id="预想"><a href="#预想" class="headerlink" title="预想"></a>预想</h2><p>我想了想这段内容谈不上设计，只是自己的一些预想罢了</p><p>我预计初步实现的网站功能如下：</p><ol><li>列出各种类型的影片，动漫，提供影片的在线观看</li><li>对动漫单独做出一个分页，包含一周更新表</li><li>提供一个VIP视频解析接口，解析资源网未更新但是是VIP才能看的视频</li></ol><hr><p>预设的网站URL：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">网站首页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/</span><br><span class="line">VIP接口解析视频页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/viparse</span><br><span class="line">最近更新的视频<span class="number">5</span>页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/latest5</span><br><span class="line">播放量排行页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/clicknums</span><br><span class="line">登录：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/login</span><br><span class="line">动漫：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/dm</span><br><span class="line">电视剧：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/tv</span><br><span class="line">综艺：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/zy</span><br><span class="line">电影：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/mv</span><br><span class="line">其他：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/ot</span><br><span class="line">视频详情页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/detail/<span class="symbol">&lt;video_id&gt;</span>.html</span><br><span class="line">视频播放页：http<span class="variable">s:</span>//www.joelyings.<span class="keyword">com</span>/lvideo/play/<span class="symbol">&lt;video_id&gt;</span>.html</span><br></pre></td></tr></table></figure><hr><p>Django中APP类型划分：</p><p>考虑到将来可能有多个数据源，所以有source模型，视频信息包含了很多项数据，所以与视频链接分为两个表</p><p><span id="inline-purple">videoAPP</span></p><p>通用的跟视频有关的APP，包含来源source模型、视频信息videoinfo模型、视频播放链接videolink模型</p><p><span id="inline-purple">vip_parseAPP</span></p><p>视频解析接口APP，单独的一个页面，提供多种VIP解析接口，vip接口的模型（表）</p><hr><p>这里的页面，后续基本上是参照AGE动漫网做的，特别粗糙</p><p>页面：(首页、VIP接口页、最近更新(5页)、点击排行、登录、标签类别页、动漫标签页单独特殊化)</p><p>这是传说中的<code>手残符号概念图-_-||</code></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">首页</span><br><span class="line">============================================================</span><br><span class="line">LOGO                                                   登录</span><br><span class="line">============================================================</span><br><span class="line">首页 | VIP | 最近更新(5页) | 点击排行                    搜索</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">动漫 | 电影 | 电视剧 | 综艺 |...(每一个标签下自动加载4*5个视频的封面<span class="code">+名称+</span>最新一集)</span><br><span class="line"></span><br><span class="line"><span class="bullet">*        </span>*        *        *        *     |    最近更新的10部  更多</span><br><span class="line"></span><br><span class="line"><span class="bullet">*        </span>*        *        *        *     |  </span><br><span class="line"></span><br><span class="line"><span class="bullet">*        </span>*        *        *        *     |  </span><br><span class="line"></span><br><span class="line"><span class="bullet">*        </span>*        *        *        *     |  </span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">友链</span><br><span class="line"></span><br><span class="line">============================================================</span><br><span class="line"></span><br><span class="line">网站信息</span><br></pre></td></tr></table></figure><hr><p>咳咳咳，下面是初步表结构：</p><p><span id="inline-blue">Source来源表</span></p><p>来源网站ID、来源网站域名、来源网站名称、网站类型（资源网、解析网）、创建时间</p><p><span id="inline-blue">Video详情表</span></p><p>videoID、video名称、别名、封面链接、video演员、导演、类型、地区、更新时间、集数、语言、上映时间、简介、来源网站名称、创建时间</p><p><span id="inline-blue">Video链接表</span></p><p>链接ID、videoID、链接url、来源网站名称、创建时间</p><p><span id="inline-blue">VIP解析接口表</span></p><p>接口ID、接口链接、是否可用、创建时间</p><p><span id="inline-blue">Video点击量表</span></p><p>视频名称，pv，uv</p><div class="note info"><p>注：</p></div><p>PV(访问量)：即Page View，具体是指网站的是页面浏览量或者点击量，页面被刷新一次就计算一次。如果网站被刷新了1000次，那么流量统计工具显示的PV就是1000</p><p>UV(独立访客)：即Unique Visitor，访问您网站的一台电脑客户端为一个访客。00:00-24:00内相同的客户端只被计算一次</p><p>一个UV可以用很多PV，一个PV也只能对应一个IP。比如，今天访问了一次你的网站，你的UV就加了1，我这次访问浏览了两个页面，你的PV就加2，我访问同一个页面，但刷新了一次，PV也是2</p><p>这里为止就是我初步预想的内容，下面就可以着手实现了！</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>这是我总结的Django项目创建的一般流程：</p><p>1、配置项目运行的虚拟环境<br>2、配置readme、requirements.txt等文件<br>3、创建项目：django-admin startproject xxx<br>4、有必要的话拆分settings.py，分为开发、线上不同配置<br>5、修改settings.py时区，语言等配置<br>6、创建APP：python3 manage.py startapp xxx<br>7、配置APP：在settings.py中的INSTALLED_APPS添加APP<br>8、根据配置好的Models和APP创建数据库表，迁移文件：python3 manage.py makemigrations<br>9、执行迁移：python3 manage.py migrate；python manage.py dbshell 可以进入sqlite交互界面<br>10、创建超级用户：python3 manage.py createsuperuser，输入用户名、邮箱密码<br>11、进入Admin，python3 manage.py runserver 启动项目后可以进入admin页面<br>12、编写admin，在admin.py中注册之前的models</p><h3 id="建立模型"><a href="#建立模型" class="headerlink" title="建立模型"></a>建立模型</h3><p>建立模型，这样一来也可以通过模型生成的表为scrapy爬虫做准备</p><p>首先在video的APP中建立三个模型，分别为Source、VideoInfo、VideoLink，这里就贴Source模型的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Source</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_UNNORMAL = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS = (</span><br><span class="line">        (STATUS_NORMAL, <span class="string">'有效地址'</span>),</span><br><span class="line">        (STATUS_UNNORMAL, <span class="string">'无效地址'</span>),</span><br><span class="line">    )</span><br><span class="line">    TYPE_ZIYUAN = <span class="number">1</span></span><br><span class="line">    TYPE_JIEXI = <span class="number">0</span></span><br><span class="line">    TYPE_ITEMS = (</span><br><span class="line">        (TYPE_ZIYUAN, <span class="string">'资源类'</span>),</span><br><span class="line">        (TYPE_JIEXI, <span class="string">'解析类'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    domin = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'来源域名'</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'来源名称'</span>)</span><br><span class="line">    type = models.PositiveIntegerField(default=TYPE_ZIYUAN, choices=TYPE_ITEMS, verbose_name=<span class="string">'来源类型'</span>)</span><br><span class="line">    is_effect = models.PositiveIntegerField(default=STATUS_NORMAL, choices=STATUS_ITEMS, verbose_name=<span class="string">'是否有效'</span>)</span><br><span class="line">    format_page = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'构造初始爬取页链接'</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>, verbose_name=<span class="string">'创建时间'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">'来源'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure><p>没有指定主键的模型，Django会自动添加id作为主键，且自动增长，模型都建好后，可以执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><p>来生成对应的表，这里我用的是mysql，所以需要在settings.py配置中修改如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'lvideo'</span>,                   <span class="comment"># 数据库名</span></span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,                     <span class="comment"># mysql username</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'xxx'</span>,                  <span class="comment"># 数据库密码</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'localhost'</span>,                <span class="comment"># host</span></span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,                     <span class="comment"># port</span></span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;<span class="string">'charset'</span>: <span class="string">'utf8mb4'</span>&#125;,  <span class="comment"># 设置编码为utf8mb4</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在，与settings.py文件同一目录下的<code>__init__.py</code>文件中加入：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure><h3 id="展示后台"><a href="#展示后台" class="headerlink" title="展示后台"></a>展示后台</h3><p>在videoAPP的admin.py中添加对应模型的admin部分代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(Source)</span></span><br><span class="line"><span class="comment"># 这里的site=custom_site是因为我分出一个用户浏览的后台管理，正常情况下只用注册第一条即可</span></span><br><span class="line"><span class="meta">@admin.register(Source, site=custom_site)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SourceAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    <span class="comment"># 模型展示的字段</span></span><br><span class="line">    list_display = [<span class="string">'domin'</span>, <span class="string">'name'</span>, <span class="string">'type'</span>, <span class="string">'is_effect'</span>, <span class="string">'format_page'</span>, <span class="string">'created_time'</span>]</span><br><span class="line">    <span class="comment"># 可供创建或修改的字段</span></span><br><span class="line">    fields = [<span class="string">'domin'</span>, <span class="string">'name'</span>, <span class="string">'is_effect'</span>, <span class="string">'type'</span>, <span class="string">'format_page'</span>]</span><br><span class="line"></span><br><span class="line">    search_fields = [<span class="string">'domin'</span>, <span class="string">'name'</span>]</span><br><span class="line">    actions_on_top = <span class="literal">True</span></span><br><span class="line">    actions_on_bottom = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 编辑页面，默认情况下保存按钮在底部</span></span><br><span class="line">    save_on_top = <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>这样一来就可以在后台管理界面添加或者修改数据了</p><h3 id="添加页面"><a href="#添加页面" class="headerlink" title="添加页面"></a>添加页面</h3><p>当前运行项目后</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure><p>能看到Django的运行成功页面，以及可以进入后台管理页面，但是并没有任何的数据展示页面，所以下面我们来编写这些页面</p><p>我们整理一下逻辑，浏览器通过访问特定的url，Django会去找到并处理对应url的view(视图)，视图中写好了我们的一系列逻辑，最后将数据传给指定的HTML页面，最终展现在我们面前的就是被渲染好的HTML页面</p><p>所以我们来看<code>urls.py</code>文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> LVideo.custom_site <span class="keyword">import</span> custom_site</span><br><span class="line"><span class="keyword">from</span> video.views <span class="keyword">import</span> IndexView, Latest5View, VideoDetailView, VideoPlayView, MoreListView, VideoPlayIndexView, \</span><br><span class="line">    SearchView, ClickView, register, login, logout</span><br><span class="line"><span class="keyword">from</span> vip_parse.views <span class="keyword">import</span> VipParseView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, IndexView.as_view(), name=<span class="string">'index'</span>),</span><br><span class="line">    path(<span class="string">'viparse'</span>, VipParseView.as_view(), name=<span class="string">'vip-parse'</span>),</span><br><span class="line">    path(<span class="string">'latest5'</span>, Latest5View.as_view(), name=<span class="string">'latest5'</span>),</span><br><span class="line">    path(<span class="string">'clicknums'</span>, ClickView.as_view(), name=<span class="string">'clicknums'</span>),</span><br><span class="line">    path(<span class="string">'login'</span>, login),</span><br><span class="line">    path(<span class="string">'register'</span>, register),</span><br><span class="line">    path(<span class="string">'logout'</span>, logout, name=<span class="string">'logout'</span>),</span><br><span class="line">    <span class="comment"># path('profile', profile, name='profile'),</span></span><br><span class="line">    path(<span class="string">'search'</span>, SearchView.as_view(), name=<span class="string">'search'</span>),</span><br><span class="line">    path(<span class="string">'dm'</span>, MoreListView.as_view(), name=<span class="string">'dm-list'</span>),</span><br><span class="line">    path(<span class="string">'tv'</span>, MoreListView.as_view(), name=<span class="string">'tv-list'</span>),</span><br><span class="line">    path(<span class="string">'zy'</span>, MoreListView.as_view(), name=<span class="string">'zy-list'</span>),</span><br><span class="line">    path(<span class="string">'mv'</span>, MoreListView.as_view(), name=<span class="string">'mv-list'</span>),</span><br><span class="line">    path(<span class="string">'ot'</span>, MoreListView.as_view(), name=<span class="string">'ot-list'</span>),</span><br><span class="line">    path(<span class="string">'detail/&lt;int:video_id&gt;.html'</span>, VideoDetailView.as_view(), name=<span class="string">'video-detail'</span>),</span><br><span class="line">    path(<span class="string">'playindex/&lt;int:video_id&gt;.html'</span>, VideoPlayIndexView.as_view(), name=<span class="string">'video-play-index'</span>),</span><br><span class="line">    path(<span class="string">'play/&lt;int:video_id&gt;/&lt;int:play_id&gt;.html'</span>, VideoPlayView.as_view(), name=<span class="string">'video-play'</span>),</span><br><span class="line">    path(<span class="string">'super_admin/'</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">'custom_admin/'</span>, custom_site.urls)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>这里列出了网站基本的可访问的路径，第一行path，路径为空指向的就是首页，也是现在的<code>127.0.0.1:8000</code>的页面，而<code>detail/&lt;int:video_id&gt;.html</code>，类似这种路径，Django视图就能拿到其中的video_id参数</p><p>我们可以看到第一行path后面跟的是<code>IndexView.as_view()</code>，也就是指向的videoAPP的views.py中的<code>IndexView</code>这个视图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里CommonListView是我继承的ListView</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span><span class="params">(CommonListView)</span>:</span></span><br><span class="line">    <span class="comment"># queryset是基础的从数据库中通过指定条件取得的结果集，比如这里我从VideoInfo模型对应的表中取出了类型为动漫的前10条数据</span></span><br><span class="line">    queryset = VideoInfo.get_type_video_list(VideoInfo.TYPE_DM)[:<span class="number">10</span>]</span><br><span class="line">    <span class="comment"># 模板中可以用到的上下文的名称</span></span><br><span class="line">    context_object_name = <span class="string">'video_list'</span></span><br><span class="line">    <span class="comment"># 模板所在的相对路径</span></span><br><span class="line">    template_name = <span class="string">'video/index_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data()</span><br><span class="line">        <span class="comment"># 根据需求添加到上下文中的数据</span></span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="string">'dm_list'</span>: super().get_queryset(),</span><br><span class="line">            <span class="string">'mv_list'</span>: VideoInfo.get_type_video_list(VideoInfo.TYPE_MV)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'tv_list'</span>: VideoInfo.get_type_video_list(VideoInfo.TYPE_TV)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'zy_list'</span>: VideoInfo.get_type_video_list(VideoInfo.TYPE_ZY)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'ot_list'</span>: VideoInfo.get_type_video_list(VideoInfo.TYPE_OT)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'dm_pv_list'</span>: VideoInfo.get_hot_video_list(VideoInfo.TYPE_DM)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'mv_pv_list'</span>: VideoInfo.get_hot_video_list(VideoInfo.TYPE_MV)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'tv_pv_list'</span>: VideoInfo.get_hot_video_list(VideoInfo.TYPE_TV)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'zy_pv_list'</span>: VideoInfo.get_hot_video_list(VideoInfo.TYPE_ZY)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'ot_pv_list'</span>: VideoInfo.get_hot_video_list(VideoInfo.TYPE_OT)[:<span class="number">10</span>],</span><br><span class="line">            <span class="string">'links'</span>: Links.get_links()</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br></pre></td></tr></table></figure><p>这里我们将许多数据都带到了模板中用作渲染，而这些获取数据的方法都被我们写在模型下面，如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    TYPE_DM, TYPE_MV, TYPE_TV, TYPE_ZY, TYPE_OT = <span class="string">'动漫'</span>, <span class="string">'电影'</span>, <span class="string">'电视剧'</span>, <span class="string">'综艺'</span>, <span class="string">'其他'</span></span><br><span class="line">    V_TYPE_LIST = &#123;</span><br><span class="line">        <span class="string">'dm'</span>: TYPE_DM,</span><br><span class="line">        <span class="string">'mv'</span>: TYPE_MV,</span><br><span class="line">        <span class="string">'tv'</span>: TYPE_TV,</span><br><span class="line">        <span class="string">'zy'</span>: TYPE_ZY,</span><br><span class="line">        <span class="string">'ot'</span>: TYPE_OT</span><br><span class="line">    &#125;</span><br><span class="line">    name = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'视频名称'</span>, db_index=<span class="literal">True</span>)</span><br><span class="line">    alias = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'别名'</span>, db_index=<span class="literal">True</span>)</span><br><span class="line">    remark = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'视频备注'</span>)</span><br><span class="line">    cover_url = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'封面链接'</span>)</span><br><span class="line">    director = models.CharField(max_length=<span class="number">512</span>, verbose_name=<span class="string">'导演'</span>)</span><br><span class="line">    actor = models.CharField(max_length=<span class="number">1024</span>, verbose_name=<span class="string">'演员'</span>)</span><br><span class="line">    first_type = models.CharField(max_length=<span class="number">256</span>, verbose_name=<span class="string">'视频类别1'</span>)</span><br><span class="line">    second_type = models.CharField(max_length=<span class="number">256</span>, verbose_name=<span class="string">'视频类别2'</span>)</span><br><span class="line">    region = models.CharField(max_length=<span class="number">256</span>, verbose_name=<span class="string">'地区'</span>)</span><br><span class="line">    update_time = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'资源更新时间'</span>)</span><br><span class="line">    nums = models.PositiveIntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'总集数'</span>)</span><br><span class="line">    release_time = models.CharField(max_length=<span class="number">64</span>, verbose_name=<span class="string">'上映年份'</span>, db_index=<span class="literal">True</span>)</span><br><span class="line">    intro = models.TextField(verbose_name=<span class="string">'简介'</span>)</span><br><span class="line">    source = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'来源网站名称'</span>)</span><br><span class="line">    created_time = models.CharField(max_length=<span class="number">128</span>, verbose_name=<span class="string">'创建时间'</span>)</span><br><span class="line"></span><br><span class="line">    pv = models.PositiveIntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'页面访问量'</span>)</span><br><span class="line">    uv = models.PositiveIntegerField(default=<span class="number">1</span>, verbose_name=<span class="string">'独立访客数'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">'视频信息'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_type_video_list</span><span class="params">(cls, v_type)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        返回相关first_type的所有video，并根据update_time倒序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = cls.objects.filter(first_type=v_type).order_by(<span class="string">'-update_time'</span>)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_hot_video_list</span><span class="params">(cls, v_type)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        返回相关first_type的所有video，并根据pv倒序</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        queryset = cls.objects.filter(first_type=v_type).order_by(<span class="string">'-pv'</span>)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_video_name</span><span class="params">(cls, video_id)</span>:</span></span><br><span class="line">        name_list = cls.objects.filter(id=video_id).values(<span class="string">'name'</span>)</span><br><span class="line">        <span class="comment"># 返回的name_list是 &lt;QuerySet [&#123;'name':xxx&#125;,]&gt;</span></span><br><span class="line">        name = name_list[<span class="number">0</span>].get(<span class="string">'name'</span>)</span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">latest_video</span><span class="params">(cls)</span>:</span></span><br><span class="line">        queryset = cls.objects.all().order_by(<span class="string">'-update_time'</span>)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_video_pu</span><span class="params">(cls, v_name)</span>:</span></span><br><span class="line">        v_pu = cls.objects.filter(name=v_name)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> v_pu</span><br></pre></td></tr></table></figure><p>这样一来view中只需要调用对应的方法就可以取得数据，model则负责取数据的具体实现，耦合度减小</p><p>而要找到view中指定模板文件，我们还需要在settings.py中配置：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR, <span class="string">'LVideo'</span>, <span class="string">'templates'</span>)],</span><br><span class="line">        <span class="string">'APP_DIRS'</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">'context_processors'</span>: [</span><br><span class="line">                <span class="string">'django.template.context_processors.debug'</span>,</span><br><span class="line">                <span class="string">'django.template.context_processors.request'</span>,</span><br><span class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</span><br><span class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line"></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'LVideo'</span>, <span class="string">'static'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>我把templates文件夹放在与settings.py同一目录下，用来存放所有的模板文件，同样的还有static文件夹，用来存放css、js文件</p><p>配置好的情况下按住ctrl点击模板文件就可以跳转到对应的html文件，差不多的我们来看首页的html文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "video/base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block login-register %&#125;</span><br><span class="line">    &#123;% if request.session.is_login %&#125;</span><br><span class="line">        &#123;% include "video/user_model.html" %&#125;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        &#123;% include "video/model.html" %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block main %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container videolist"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"h5"</span> <span class="attr">id</span>=<span class="string">"more"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'dm-list' %&#125;"</span>&gt;</span>动漫<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row videotype"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-9"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-inline index-9"</span>&gt;</span></span><br><span class="line">                &#123;% for video in dm_list %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-inline-item p-2"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cover_img_span1"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"cover_remark"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.remark &#125;&#125;"</span>&gt;</span>&#123;&#123; video.remark &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"120px"</span> <span class="attr">height</span>=<span class="string">"165px"</span> <span class="attr">class</span>=<span class="string">"cover_img"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; video.cover_url &#125;&#125;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-truncate text-center"</span> <span class="attr">style</span>=<span class="string">"max-width: 120px;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span>&#123;&#123; video.name &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-3 time"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row timetable"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"time-play"</span>&gt;</span>新番时间表<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;#                &#123;% include 'video/timetable.html' %&#125;#&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-inline time"</span>&gt;</span></span><br><span class="line">                &#123;% for video in dm_pv_list %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">dl</span> <span class="attr">class</span>=<span class="string">"row"</span> <span class="attr">style</span>=<span class="string">"margin-bottom: 0;"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">dt</span> <span class="attr">class</span>=<span class="string">"col-sm-7"</span> <span class="attr">style</span>=<span class="string">"font-weight: unset;"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"d-inline-block text-truncate"</span> <span class="attr">style</span>=<span class="string">"max-width: 150px;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span>&#123;&#123; video.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">dt</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">dd</span> <span class="attr">class</span>=<span class="string">"col-sm-5"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"d-inline-block"</span> <span class="attr">style</span>=<span class="string">"height: 24px; width: 90px; overflow: hidden;"</span>&gt;</span>&#123;&#123; video.update_time &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dl</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block links %&#125;</span><br><span class="line">    &#123;% for link in links %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; link.link &#125;&#125;"</span>&gt;</span>&#123;&#123; link.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>这里我们的<code>index_list.html</code>文件实际上是<code>extend</code>继承了<code>base.html</code>文件，实际上就是以<code>base.html</code>为母板，在上面挖了许多的<code>block</code>，而<code>index_list.html</code>中<code>block block_name...endblock</code>中的内容就是用来填充<code>block</code>的</p><p>而对应的也有<code>include</code>某个html文件，即将里面的内容拿到<code>include</code>的位置</p><p>模板中也有几个需要注意的点，以这一部分为例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># dm_list，就是view传入的上下文中的数据集之一，里面包含的是动漫类型的视频信息</span><br><span class="line">&#123;% for video in dm_list %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-inline-item p-2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cover_img_span1"</span>&gt;</span></span><br><span class="line">        # 这个a标签中的href没有直接写为url路径，而是通过urls.py中对应的url路径的name反向解析成url，实现了低耦合</span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"cover_remark"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.remark &#125;&#125;"</span>&gt;</span>&#123;&#123; video.remark &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"120px"</span> <span class="attr">height</span>=<span class="string">"165px"</span> <span class="attr">class</span>=<span class="string">"cover_img"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; video.cover_url &#125;&#125;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-truncate text-center"</span> <span class="attr">style</span>=<span class="string">"max-width: 120px;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span>&#123;&#123; video.name &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p id="div-border-left-red">按照这样下来之后，就能看到基本的页面，剩下的就是爬虫的开发，以及页面的功能、模板的具体实现，由于这是在项目基本完成之后才写的，中间很多步骤无法连贯起来，但是这里还是记录下大致的过程用来日后可以简单的回溯一下</p><p>下一篇大致是许多问题以及细节的处理过程，还有项目部署的大致过程</p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://joelying.github.io/post/8adedfb3.html#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
