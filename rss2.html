<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>JoelYing</title>
    <link>https://blog.joelyings.com/</link>
    <atom:link href="/rss2.html" rel="self" type="application/rss+xml"/>
    
    <description>半个兴趣使然的程序员</description>
    <pubDate>Fri, 07 Feb 2020 13:50:29 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>Valine评论邮件提醒</title>
      <link>https://blog.joelyings.com/post/ed7ca194.html</link>
      <guid>https://blog.joelyings.com/post/ed7ca194.html</guid>
      <pubDate>Fri, 07 Feb 2020 12:30:22 GMT</pubDate>
      <description>
      
        我见青山多妩媚，料青山见我应如是
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Wed Feb 26 2020 13:38:42 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-07_1.jpg"><a id="more"></a><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>总是担心有人给博文留言了却不能及时的看到回复，于是想有没有可以一留言就能提醒作者的功能，正好用的是Valine，于是搜索了下，然后在这里记录下Valine评论通过邮件提醒的方法</p><p>Valine官方提供的邮件提醒功能是基于Leancloud的密码重置邮件提醒，可以在<code>你的应用-设置-邮件模板</code>中修改</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>参照网上的建议最后决定使用<a href="https://github.com/zhaojun1998/Valine-Admin" target="_blank" rel="noopener">第三方的邮件提醒</a></p><p>当然前提是确保Valine的基础功能是正常的已经能够评论，并且<code>自带的邮件提醒</code>是关闭的</p><figure class="highlight plain"><figcaption><span>themes\next\_config.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">valine:</span><br><span class="line">  ...</span><br><span class="line">  notify: false  # 设置notify为false</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><h3 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h3><p>然后进入<a href="https://leancloud.cn/" target="_blank" rel="noopener">Leancloud</a>对应的Valine应用中</p><p>点击<code>云引擎 -&gt; 设置</code>填写代码库并保存：<code>https://github.com/zhaojun1998/Valine-Admin</code></p><p><img src="http://image.joelyings.com/2020-02-07_2.png" alt></p><p>切换到部署标签页，点击Git源码部署，分支使用 master，点击部署</p><p><img src="http://image.joelyings.com/2020-02-07_3.png" alt></p><p>此外，你需要设置云引擎的环境变量以提供必要的信息，点击云引擎的设置页，设置如下信息</p><p><img src="http://image.joelyings.com/2020-02-07_4.png" alt></p><p>必选参数：</p><ul><li>SITE_NAME : 网站名称</li><li>SITE_URL : 网站地址, 最后不要加 /</li><li>SMTP_USER : SMTP 服务用户名，一般为邮箱地址</li><li>SMTP_PASS : SMTP 密码，一般为授权码，而不是邮箱的登陆密码，请自行查询对应邮件服务商的获取方式</li><li>SMTP_SERVICE : 邮件服务提供商，支持 QQ、163、126、Gmail、”Yahoo”、…… ，全部支持请参考 : <a href="https://nodemailer.com/smtp/well-known/#supported-services" target="_blank" rel="noopener">Nodemailer Supported services</a> — 如这里没有你使用的邮件提供商，请查看<a href="https://github.com/zhaojun1998/Valine-Admin/blob/master/%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE.md#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener">自定义邮件服务器</a></li><li>SENDER_NAME : 寄件人名称</li></ul><hr><p>若采用企业邮箱，这边的SMTP_SERVICE就不适用了，需要用这三个参数替换：<code>SMTP_HOST</code>、<code>SMTP_PORT</code>、<code>SMTP_SECURE</code></p><ul><li>SMTP_HOST : 邮件服务提供商 SMTP 地址，如 <code>qq : smtp.qq.com</code>，此项需要自行查询或询问其服务商</li><li>SMTP_PORT : 邮件服务提供商 SMTP 端口, 此项需要自行查询或询问其服务商</li><li>SMTP_SECURE : 是否启用加密, 默认为 true，一般不需要设置，如有特殊请自行配置。 此项需要自行查询或询问其服务商。</li></ul><p>可以看到上图中，我的自定义环境变量还多了2个，分别是：</p><ul><li>TO_EMAIL ：这个是填收邮件提醒的邮箱地址，若没有这个字段，则将邮件发到SMTP_USER</li><li>TEMPLATE_NAME：设置提醒邮件的主题，目前内置了两款主题，分别为 default 与 rainbow。默认为 default</li></ul><hr><h3 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h3><p>上面的文档没有介绍怎么获取SMTP授权码，这里说明一下<code>QQ邮箱</code>的：</p><p>进入QQ邮箱，点击上方的<code>设置</code></p><p><img src="http://image.joelyings.com/2020-02-07_6.png" alt></p><p>点击<code>账户</code>选项，往下拉</p><p><img src="http://image.joelyings.com/2020-02-07_7.png" alt></p><p>看到这里的<code>POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务</code>，开启<code>POP3/SMTP服务</code>，然后点击下方的<code>生成授权码</code></p><p><img src="http://image.joelyings.com/2020-02-07_8.png" alt></p><p>这里会要求你用密保手机发短信，然后点<code>我已发送</code>按钮，然后可以看到如下的授权码</p><p><img src="http://image.joelyings.com/2020-02-07_9.png" alt></p><p>复制到<code>SMTP_PASS</code>即可，记得保存</p><h3 id="LeanCloud休眠策略"><a href="#LeanCloud休眠策略" class="headerlink" title="LeanCloud休眠策略"></a>LeanCloud休眠策略</h3><p>配置完这些还要注意，免费版的LeanCloud容器，是有强制性休眠策略的，不能 24 小时运行</p><ul><li>每天必须休眠 6 个小时</li><li>30 分钟内没有外部请求，则休眠</li><li>休眠后如果有新的外部请求实例则马上启动（但激活时此次发送邮件会失败）</li></ul><p>分析了一下上方的策略，如果不想付费的话，最佳使用方案就设置定时器，每天 7 - 23 点每 20 分钟访问一次，这样可以保持每天的绝大多数时间邮件服务是正常的</p><p><strong>方法一</strong></p><p>附 Linux crontab 定时器代码：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/<span class="number">20</span> <span class="number">7</span><span class="number">-23</span> * * * curl https:<span class="comment">//你配置的域名前缀.leanapp.cn</span></span><br></pre></td></tr></table></figure><p><strong>方法二</strong></p><p>首先需要先配置下 Web 主机的域名，使用定时器时要用到，配置方式如下：</p><p><img src="http://image.joelyings.com/2020-02-07_10.png" alt></p><p>后台登录需要账号密码，需要在这里设置，只需要填写 email、password、username，这三个字段即可, 使用 email 作为账号登陆即可。（为了安全考虑，此 email 必须为配置中的 SMTP_USER 或 TO_EMAIL， 否则不允许登录）</p><p><img src="http://image.joelyings.com/2020-02-07_11.png" alt></p><p>事实上我是分配到了一个预备环境的域名，不管了，直接跳到定时任务</p><p>LeanCloud 自带定时器[推荐]</p><p>首先需要添加环境变量，<code>ADMIN_URL：Web 主机域名</code>，如图所示（添加后重启容器才会生效），保存</p><p><img src="http://image.joelyings.com/2020-02-07_12.png" alt></p><p>然后点击<code>云引擎 - 定时任务</code>，创建定时任务，按照图片上填写：</p><p><img src="http://image.joelyings.com/2020-02-07_13.png" alt></p><p>注意, LeanCloud 最近更新了定时器校验规则, 需要将 Cron 表达式写为: <code>0 */20 7-23 * * ?</code></p><p>添加后默认就已启动，启用成功后，每 20 分钟在<code>云引擎的 - 应用日志</code>中可以看到提示</p><p>完成后记得，在<code>云引擎-实例</code>中，重启</p><p><img src="http://image.joelyings.com/2020-02-07_14.png" alt></p><p>等待重启完毕，在你的博文下评论后，你的邮箱就会收到如下的提醒：</p><p><img src="http://image.joelyings.com/2020-02-07_5.png" alt></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/zhaojun1998/Valine-Admin" target="_blank" rel="noopener">Valine-Admin</a><br><a href="https://www.nhtzj.com/3315416634/#comments" target="_blank" rel="noopener">NexT主题设置Valine评论系统邮件提醒</a><br><a href="https://blog.csdn.net/qq_21808961/article/details/84639401" target="_blank" rel="noopener">hexo next主题 valine评论系统 使用第三方邮件提醒</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://blog.joelyings.com/post/ed7ca194.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Hexo博客华为云域名解析</title>
      <link>https://blog.joelyings.com/post/8edf7a7d.html</link>
      <guid>https://blog.joelyings.com/post/8edf7a7d.html</guid>
      <pubDate>Fri, 07 Feb 2020 04:32:22 GMT</pubDate>
      <description>
      
        The first rule of Fight Club is you do not talk about Fight Club
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Wed Feb 26 2020 13:38:42 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-07_16.jpg"><a id="more"></a><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>Hexo 绑定个人域名（华为云）</p><h3 id="购买域名"><a href="#购买域名" class="headerlink" title="购买域名"></a>购买域名</h3><p>进入华为云域名注册 <a href="https://www.huaweicloud.com/product/domain.html" target="_blank" rel="noopener">https://www.huaweicloud.com/product/domain.html</a>，搜索自己喜欢的域名</p><p>选择自己喜欢的域名（建议选择常见的，比如说：com，cn，net之类的，考虑到兼容性的问题），然后进行购买</p><p>选择好要购买的期限和域名信息模板（没有的自己建一个，里面的要填写的信息没有特别要讲究的）</p><p>要注意的就是域名购买后，域名信息要实名认证成功后，购买的域名才可以被解析（通俗的说：能被使用）</p><h3 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h3><p>前提是域名到账户上，并且成功实名认证后</p><p>进入华为云控制台，在华为云服务搜索框中搜素 云解析服务 DNS，然后进入。</p><p>一般来说是在公网解析中，在里面可以看到你购买成功的域名，然后点击解析，不用管其它的，直接点击进行设置。填入信息后，确定即可添加成功。</p><table><thead><tr><th align="left">填写目录</th><th align="left">填写信息</th></tr></thead><tbody><tr><td align="left">主机记录</td><td align="left">旁边有个问号，里面有详解，我是直接填了<code>www</code></td></tr><tr><td align="left">类型</td><td align="left">普通的只需要A、CNAME（详情的可以看后面的跟的说明），我选择的是<code>CNAME</code></td></tr><tr><td align="left">别名</td><td align="left">不用管，没用到，选<code>否</code></td></tr><tr><td align="left">线路类型</td><td align="left">普通的<code>全网默认</code>就行了</td></tr><tr><td align="left">TTL</td><td align="left">默认，<code>5分钟</code></td></tr><tr><td align="left">值</td><td align="left">CNAME： 填写需要绑定的域名（例：genmcai.github.io） A： 填写需要绑定的IP（查看方法放下面）</td></tr><tr><td align="left">权重</td><td align="left">可选参数，解析记录的权重，可选参数，默认值为1。取值范围：0~100。当域名有多条某一类型的解析记录时，根据权重数值选择解析记录，权重数值越高，优先级越高</td></tr></tbody></table><p>IP查看方法</p><p>Ctrl+R 进入 运行 输入 cmd ，输入命令 Ping 域名(例：Ping genmcai.github.io)</p><p>下面出现的IPv4地址即是 A 所需的值</p><p>进入github，到存放网站的仓库，<code>Settings -&gt; Options -&gt; GitHub Pages -&gt; Custom domain -&gt; 填写需要绑定的个人域名</code> 点击save后，网站上会提示是否成功</p><h3 id="最后一步"><a href="#最后一步" class="headerlink" title="最后一步"></a>最后一步</h3><p>在hexo的根目录下source 中添加一个无后缀名的文件（文件名：CNAME），里面内容填写你绑定的域名</p><p>至于有些同学会问怎么写入，这个可以直接先txt填入内容后删掉后缀名，或者用VS code之类的打开无后缀名的文件，也能写入</p><p>这一步可以说挺重要的，如果没有这个文件，<code>hexo g -d</code>提交后，页面就会变成404，这个时候重复第3个步骤就能恢复，不过每次都这样很麻烦，而且可能会清空博客访问记录</p><p>至此，个人域名的绑定就结束了，重新使用自己的个人域名进行访问，就能访问到绑定的hexo了。如果出现错误，有可能是主题版本的原因，也有可能是其他的原因</p><h2 id="两端部署"><a href="#两端部署" class="headerlink" title="两端部署"></a>两端部署</h2><p>原本博客是在github的，访问<a href="https://joelying.github.io/" target="_blank" rel="noopener">https://joelying.github.io/</a>即可进入，后来用华为云的域名<code>blog.joelyings.com</code>解析<code>joelying.github.io</code>，就可以通过访问<code>blog.joeyings.com</code>进入博客</p><p>如果只想部署在coding上的hexo项目通过域名访问，可以解除了<code>GitHub Pages -&gt; Custom domain</code>中绑定的<code>blog.joelyings.com</code>，也就是现在可以访问原来的<a href="https://joelying.github.io/" target="_blank" rel="noopener">https://joelying.github.io/</a>（github）</p><p>然后在coding的hexo项目的静态网站中设置要绑定的域名（华为云）</p><p>在华为云域名解析设置中添加<code>CNAME</code>记录指向<code>xxx.coding-pages.com</code></p><p>当显示的已绑定域名<code>blog.joelyings.com</code>的证书状态为<code>正常</code>时，就可以成功访问<code>blog.joelyings.com</code></p><p>即现在可以访问<a href="blog.joelyings.com">blog.joelyings.com</a>（coding）</p><hr><p>当然要想两端都部署，然后通过一个域名访问的话：</p><ol><li><p>要在github的<code>xxx.github,io</code>的项目settings中的<code>Options -&gt; GitHub Pages -&gt; Custom domain</code>处添加你的域名，并确保在（华为云）域名解析处有指向<code>xxx.github,io</code>的CNAME解析，在<code>Custom domain</code>处看到<code>Your site is ready to be published at https://xxx.xxx.com</code>就成功</p></li><li><p>在coding的项目的静态网站（默认没有静态网站的可以去项目设置的功能开关中打开构建与部署）设置中，添加绑带域名，也确保华为云域名解析设置中添加<code>CNAME</code>记录指向<code>xxx.coding-pages.com</code></p></li></ol><h2 id="SEO优化"><a href="#SEO优化" class="headerlink" title="SEO优化"></a>SEO优化</h2><h3 id="收录"><a href="#收录" class="headerlink" title="收录"></a>收录</h3><p>先到<a href="https://ziyuan.baidu.com/site/siteadd#/" target="_blank" rel="noopener">这里</a>，登录账号之后：右上角用户中心 -&gt; 然后左侧站点管理 -&gt; 添加网站</p><p>选择<code>https</code>协议头，输入你要添加的网站，选择站点属性，再来到验证网站</p><p>这里选择CNAME验证，将<code>xxx.你提交的网站域名</code>使用CNAME解析到<code>ziyuan.baidu.com</code></p><p>完成后点击<code>完成验证</code>按钮</p><p>为保持验证通过的状态，成功验证后请不要删除该DNS记录，然后等待一会，验证通过即收录网站成功</p><h3 id="sitemap"><a href="#sitemap" class="headerlink" title="sitemap"></a>sitemap</h3><p>先安装生成sitemap的插件，在站点的根目录下执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-sitemap --save</span><br></pre></td></tr></table></figure><div class="note warning"><p>不用安装hexo-generator-baidu-sitemap，有的教程会告诉你，这个是专门针对百度的sitemap，其实根本不是。这个插件本身最开始只是为了本地搜索做的，用的时候，如果标题里面带有&这种本身有预定义的符号，后续提交的时候会出现解析出错，所以不用安装。</p></div><p>安装好了之后，再生成一次网页，也就是执行一次<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code></p><p>然后会在<code>/yoursite/public/</code>下面看到<code>sitemap.xml</code>文件</p><h3 id="提交sitemap"><a href="#提交sitemap" class="headerlink" title="提交sitemap"></a>提交sitemap</h3><p>打开百度站长平台，进入你刚刚添加的站点</p><p>先点击左侧链接提交，然后点击sitemap</p><p>填入<code>你的站点名称/sitemap.xml</code>，或者你有自己的域名，只是在coding上托管代码，就填入<code>域名/sitemap.xml</code>，如果不确定的话，可以先把这个链接<strong>在浏览器中打开试试</strong></p><p>如果看不到xml页面，请检查你的站点配置文件中的<code>url</code>是否改成了你的域名</p><figure class="highlight plain"><figcaption><span>_config.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># URL</span><br><span class="line">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</span><br><span class="line">url: https://blog.joelyings.com</span><br><span class="line">root: /</span><br><span class="line">permalink: :year/:month/:day/:title/</span><br><span class="line">permalink_defaults:</span><br></pre></td></tr></table></figure><p>然后提交上去，下面会有结果，刷新之后会显示状态正常，后面还有提取的链接数量（可能很久，且注意github端也部署的话会导致百度抓取超时而发生错误，所以最后我把网站只部署在Coding）</p><p>sitemap会定期自动更新，如果添加了新页面，想快速收录的话，可以手动更新文件</p><div class="note info"><p>site:blog.joelyings.com 可以看你的网站是否被收录了</p></div><h3 id="自动推送"><a href="#自动推送" class="headerlink" title="自动推送"></a>自动推送</h3><p>自动退送的话，Hexo框架已经给我们集成好了，只需要修改主题配置文件：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">baidu_push:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>将这个改成true，在你每次执行hexo d的时候就会自动推送到百度</p><h3 id="添加蜘蛛协议"><a href="#添加蜘蛛协议" class="headerlink" title="添加蜘蛛协议"></a>添加蜘蛛协议</h3><p>蜘蛛协议就是告诉爬虫，你的哪些文件爬虫可以爬取，哪些不能的文件</p><p>新建一个robots.txt文件，添加以下内容，然后放到/yoursite/source/文件夹下面：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">User-agent</span>: *</span><br><span class="line"><span class="attribute">Allow</span>: /</span><br><span class="line"><span class="attribute">Allow</span>: /archives/</span><br><span class="line"><span class="attribute">Allow</span>: /tags/</span><br><span class="line"><span class="attribute">Allow</span>: /categories/</span><br><span class="line"><span class="attribute">Allow</span>: /about/</span><br><span class="line"></span><br><span class="line"><span class="attribute">Disallow</span>: /js/</span><br><span class="line"><span class="attribute">Disallow</span>: /css/</span><br><span class="line"><span class="attribute">Disallow</span>: /lib/</span><br><span class="line"></span><br><span class="line"><span class="attribute">Sitemap</span>: 刚刚sitemap的地址</span><br></pre></td></tr></table></figure><p>执行<code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code>，就同步到了coding上了</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.genmcai.com/2019/08/03/hexo_DomainName/" target="_blank" rel="noopener">Hexo 绑定个人域名（华为云版）</a><br><a href="https://segmentfault.com/q/1010000004557073" target="_blank" rel="noopener">个人域名如何同时绑定 github 和 coding 上的博客</a><br><a href="http://dugblog.coding.me/Hexo/20180625-Hexo-SEO.html" target="_blank" rel="noopener">Hexo个人博客SEO优化——如何被百度谷歌收录</a><br><a href="https://www.jianshu.com/p/7103fbbe1eba" target="_blank" rel="noopener">同时托管博客到github和coding</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://blog.joelyings.com/post/8edf7a7d.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Django搭建免费视频网站其三</title>
      <link>https://blog.joelyings.com/post/f3026717.html</link>
      <guid>https://blog.joelyings.com/post/f3026717.html</guid>
      <pubDate>Thu, 06 Feb 2020 08:04:20 GMT</pubDate>
      <description>
      
        情，心中青梅，年老仍记年少涩
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Wed Feb 26 2020 13:38:41 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_8.jpg"><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><a href="https://github.com/joelYing/LVideo" target="_blank" rel="noopener">代码传送门</a></p><h3 id="登录注册功能"><a href="#登录注册功能" class="headerlink" title="登录注册功能"></a>登录注册功能</h3><p>在base.html中挖个block：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> login-register %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>在需要的页面上填补</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block login-register %&#125;</span><br><span class="line">    &#123;% if request.session.is_login %&#125;</span><br><span class="line">        &#123;% include "video/user_model.html" %&#125;</span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">        &#123;% include "video/model.html" %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>包含登录注册的按钮</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav navbar-right"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span> <span class="attr">id</span>=<span class="string">"register-btn"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#register"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>&amp;nbsp;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span> <span class="attr">id</span>=<span class="string">"login-btn"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#login"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"glyphicon glyphicon-login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 注册窗口 --&gt;</span></span><br><span class="line">&#123;% include 'video/register.html' %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 登录窗口 --&gt;</span></span><br><span class="line">&#123;% include 'video/login.html' %&#125;</span><br></pre></td></tr></table></figure><p>登录注册，我采用的是bootstrap的模态框modal</p><p>登录部分：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"login"</span> <span class="attr">class</span>=<span class="string">"modal fade"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-dialog"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content l-register-login"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"close l-register-login"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>&amp;times;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-title"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-center"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-body"</span>&gt;</span></span><br><span class="line">                # 模态框的主体form部分</span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-group"</span> <span class="attr">id</span>=<span class="string">"loginform"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    &#123;% csrf_token %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"l-username"</span> <span class="attr">placeholder</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-left"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"alert-warning"</span> <span class="attr">id</span>=<span class="string">"login-info"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-right"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"loginbtn"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-dismiss</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#register"</span>&gt;</span>还没有账号？点我注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">                &#123;#const token = $('input[name=csrfmiddlewaretoken]').val();#&#125;</span><br><span class="line"><span class="javascript">                $(<span class="string">"#loginbtn"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    $.ajax(&#123;</span></span><br><span class="line">                        &#123;#cache:false,#&#125;</span><br><span class="line"><span class="actionscript">                        type:<span class="string">"POST"</span>,</span></span><br><span class="line"><span class="actionscript">                        url:<span class="string">"/login"</span>,</span></span><br><span class="line"><span class="actionscript">                        dataType:<span class="string">'json'</span>,</span></span><br><span class="line">                        data:&#123;</span><br><span class="line"><span class="actionscript">                            <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span></span><br><span class="line"><span class="javascript">                            <span class="string">"username"</span>: $(<span class="string">"#l-username"</span>).val(),</span></span><br><span class="line"><span class="javascript">                            <span class="string">"password"</span>: $(<span class="string">"#password"</span>).val(),</span></span><br><span class="line">                        &#125;,</span><br><span class="line"><span class="actionscript">                        <span class="comment">//通过id找到提交form表单，并将表单转成字符串</span></span></span><br><span class="line"><span class="javascript">                        <span class="keyword">async</span>:<span class="literal">true</span>,</span></span><br><span class="line"><span class="actionscript">                        <span class="comment">//异步为真，ajax提交的过程中，同时可以做其他的操作</span></span></span><br><span class="line"><span class="actionscript">                        success:<span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">                            <span class="comment">//jquery3以后，会将回传过来的字符串格式的data自动json解析不用再使用一遍JSON.parse(data)了，不然反而会在控制台报错</span></span></span><br><span class="line"><span class="actionscript">                            <span class="keyword">if</span>(data.status===<span class="string">"success"</span>) &#123;</span></span><br><span class="line">                                &#123;#$("#login-info").text(data.msg);#&#125;</span><br><span class="line">                                &#123;#$('#login').modal('hide');#&#125;</span><br><span class="line"><span class="javascript">                                <span class="built_in">window</span>.location.reload();</span></span><br><span class="line">                            &#125;</span><br><span class="line"><span class="actionscript">                            <span class="keyword">else</span> <span class="keyword">if</span>(data.status===<span class="string">"fail"</span>)&#123;</span></span><br><span class="line"><span class="javascript">                                $(<span class="string">'#login-info'</span>).text(data.msg);</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            &#123;#console.log(data);#&#125;</span><br><span class="line">                            &#123;#console.log(data.status);#&#125;</span><br><span class="line">                            &#123;#console.log(data.message);#&#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line"><span class="actionscript">                <span class="comment">//如果显示了错误信息，修改输入框内容，错误信息隐藏</span></span></span><br><span class="line"><span class="javascript">                $(<span class="string">"input"</span>).bind(<span class="string">'input propertychange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    $(<span class="string">'#login-info'</span>).html(<span class="string">''</span>);</span></span><br><span class="line">                &#125;);</span><br><span class="line">            <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>登录部分逻辑：</p><p>通过ajax提交登录的用户名以及密码，视图层对接收到的用户名密码进行校验，若成功则返回登录成功的信息，并设置session，传回来的信息若成功则会刷新当前页面，同时判断session中<code>is_login</code>是否为True，若为True，则登录注册按钮替换为用户名和注销按钮</p><p>注意点：</p><p>通过ajax给弹出来的模态框中的登录提交按钮添加点击事件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type:<span class="string">"POST"</span>,           <span class="comment">// 请求类型</span></span><br><span class="line">    url:<span class="string">"/login"</span>,          <span class="comment">// 请求的路径</span></span><br><span class="line">    dataType:<span class="string">'json'</span>,       <span class="comment">// 数据格式</span></span><br><span class="line">    data:&#123;</span><br><span class="line">        <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,  <span class="comment">// 避免提交时Forbidden (CSRF token missing or incorrect.)</span></span><br><span class="line">        <span class="string">"username"</span>: $(<span class="string">"#l-username"</span>).val(),         <span class="comment">// 注意取值时用 val()</span></span><br><span class="line">        <span class="string">"password"</span>: $(<span class="string">"#password"</span>).val(),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span>:<span class="literal">true</span>,                                     <span class="comment">// 异步为真，ajax提交的过程中，同时可以做其他的操作</span></span><br><span class="line">    success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//jquery3以后，会将回传过来的字符串格式的data自动json解析不用再使用一遍JSON.parse(data)了，不然反而会在控制台报错</span></span><br><span class="line">        <span class="keyword">if</span>(data.status===<span class="string">"success"</span>) &#123;</span><br><span class="line">            <span class="built_in">window</span>.location.reload();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(data.status===<span class="string">"fail"</span>)&#123;              <span class="comment">// 若返回的信息中 status为fail ，则打印msg</span></span><br><span class="line">            $(<span class="string">'#login-info'</span>).text(data.msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>登录部分视图层逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span> <span class="keyword">and</span> request.POST:</span><br><span class="line">        data = request.POST</span><br><span class="line">        username = data.get(<span class="string">"username"</span>)</span><br><span class="line">        password = data.get(<span class="string">"password"</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">and</span> password:</span><br><span class="line">            custom = Custom.objects.filter(username=username).first()</span><br><span class="line">            <span class="keyword">if</span> custom:</span><br><span class="line">                now_password = Custom.md5_pwd(password)</span><br><span class="line">                db_password = custom.password</span><br><span class="line">                <span class="keyword">if</span> now_password == db_password:</span><br><span class="line">                    response = JsonResponse(&#123;<span class="string">"status"</span>: <span class="string">"success"</span>, <span class="string">"msg"</span>: <span class="string">"登录成功"</span>&#125;)</span><br><span class="line">                    <span class="comment"># response.set_cookie('username', username, max_age=7 * 24 * 3600)</span></span><br><span class="line">                    <span class="comment"># response.set_cookie('password', password, max_age=7 * 24 * 3600)</span></span><br><span class="line">                    <span class="comment"># 通过session识别用户并保持用户状态</span></span><br><span class="line">                    request.session[<span class="string">'is_login'</span>] = <span class="literal">True</span></span><br><span class="line">                    request.session[<span class="string">'username'</span>] = username</span><br><span class="line">                    <span class="keyword">return</span> response</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "密码错误"&#125;'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户不存在"&#125;'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户名或密码为空"&#125;'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "请求失败"&#125;'</span>)</span><br></pre></td></tr></table></figure><p>注意HttpResponse与JsonResponse使用时的差别！！！</p><p>登陆成功后刷新页面过程会判断session.is_login，若是True，就显示<code>video/user_model.html</code>中的用户名及注销按钮：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> login-register %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.session.is_login %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> "video/user_model.html" %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> "video/model.html" %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>注册视图层逻辑：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span> <span class="keyword">and</span> request.POST:</span><br><span class="line">        data = request.POST</span><br><span class="line">        username = data.get(<span class="string">"username"</span>)</span><br><span class="line">        email = data.get(<span class="string">"email"</span>)</span><br><span class="line">        password1 = data.get(<span class="string">"password1"</span>)</span><br><span class="line">        password2 = data.get(<span class="string">"password2"</span>)</span><br><span class="line">        custom = Custom.objects.filter(username=username)</span><br><span class="line">        custom_email = Custom.objects.filter(email=email)</span><br><span class="line">        <span class="keyword">if</span> custom:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "用户名已存在，请重新输入"&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> password1 != password2:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "亲~两次密码输入不一致，请重新输入"&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> custom_email:  <span class="comment"># 邮箱地址唯一</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "该邮箱已注册，请换一个邮箱"&#125;'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 注册成功，创建用户</span></span><br><span class="line">            Custom.objects.create(</span><br><span class="line">                username=username,</span><br><span class="line">                email=email,</span><br><span class="line">                password=Custom.md5_pwd(password1),</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 重定向到登录页面</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "success", "msg": "注册成功"&#125;'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status": "fail", "msg": "请求失败"&#125;'</span>)</span><br></pre></td></tr></table></figure><p>注销视图层逻辑：</p><p>点击注销按钮，如果拿到<code>is_login</code>的值为True，那么刷新session，清除了用户的登录状态，然后重定向回index页面，重定向过程判断<code>is_login</code>值不存在，就会显示登录注册的按钮</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.session.get(<span class="string">'is_login'</span>):</span><br><span class="line">        request.session.flush()</span><br><span class="line">        <span class="comment"># flush会一次性清空session中所有内容，可以使用下面的方法</span></span><br><span class="line">        <span class="comment"># del request.session['is_login']</span></span><br><span class="line">        <span class="comment"># del request.session['user_id']</span></span><br><span class="line">        <span class="comment"># del request.session['user_name']</span></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">"index"</span>)</span><br></pre></td></tr></table></figure><h3 id="ajax"><a href="#ajax" class="headerlink" title="ajax"></a>ajax</h3><p>ajax传的数据格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data:&#123;</span><br><span class="line">    <span class="string">"name"</span>: $(<span class="string">"#id_name"</span>).val(),      <span class="comment">// 在"#"号后面是控件id， 所以千万不要搞错了，要不然会出大事的</span></span><br><span class="line">    <span class="string">"limit"</span>: $(<span class="string">"#id_limit"</span>).val(),</span><br><span class="line">    <span class="string">"address"</span>: $(<span class="string">"#id_address"</span>).val(),</span><br><span class="line">    <span class="string">"start_time"</span>: $(<span class="string">"#id_start_time"</span>).val(),</span><br><span class="line">    <span class="string">"status"</span>: $(<span class="string">"#id_status"</span>).val(),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>view层返回到ajax的数据应该如以下类型：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ return HttpResponse('&#123;"status": "success", "msg": "登录成功"&#125;')</span></span><br></pre></td></tr></table></figure><p>而不是</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- return HttpResponse('&#123;"status": "success"&#125;, &#123;"msg": "登录成功"&#125;')</span></span><br></pre></td></tr></table></figure><p>ajax实现发送post请求到服务器并返回结果信息到HTML页面主要逻辑参考：<br><a href="https://cloud.tencent.com/developer/article/1145518" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1145518</a><br><a href="https://blog.csdn.net/Jayden_Gu/article/details/82386565" target="_blank" rel="noopener">https://blog.csdn.net/Jayden_Gu/article/details/82386565</a></p><p>用ajax实现点击登录弹出对话框登陆，成功后页面不刷新，修改登录为用户名：</p><p><a href="https://www.cnblogs.com/chenxi188/p/12176700.html" target="_blank" rel="noopener">Cookie版参考</a></p><p>ajax发送请求后，在views中，若成功登录的条件符合，接下来就添加给response添加set_cookie为username，这样一来request中就保留了cookie的信息，而再通过判断取得cookie中的username，若为空则用户未登录，若有值则将这个值传入模板中渲染即可</p><p><a href="https://www.jianshu.com/p/4f84d0e0c8c9" target="_blank" rel="noopener">session版参考</a></p><p>解决注销，session保持会话状态的问题，Django的模板中可以直接引用request.session</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_44239541/article/details/89055637" target="_blank" rel="noopener">基础功能逻辑</a><br><a href="https://blog.csdn.net/u012561176/article/details/84552532" target="_blank" rel="noopener">表单提交</a><br><a href="https://blog.csdn.net/qq_26421325/article/details/44153039" target="_blank" rel="noopener">消息提示</a><br><a href="https://blog.csdn.net/miaoqinian/article/details/80668003" target="_blank" rel="noopener">HttpResponse、render,、redirect</a><br><a href="https://www.jianshu.com/p/4ffd7184b611" target="_blank" rel="noopener">注册登录弹出模态框</a><br><a href="https://www.cnblogs.com/iqian/p/5784972.html" target="_blank" rel="noopener">ajax格式</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://blog.joelyings.com/post/f3026717.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Pyqt5实现一个小项目的界面</title>
      <link>https://blog.joelyings.com/post/8d24b1e6.html</link>
      <guid>https://blog.joelyings.com/post/8d24b1e6.html</guid>
      <pubDate>Wed, 05 Feb 2020 14:28:46 GMT</pubDate>
      <description>
      
        天上剑仙三百万，遇我也需尽低眉
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Wed Feb 26 2020 13:38:42 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_3.jpg"><a id="more"></a><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装Pyqt5</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyqt5 -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><p>安装Qtcreator，<a href="http://download.qt.io/official_releases/qtcreator/" target="_blank" rel="noopener">地址</a></p><h2 id="制作"><a href="#制作" class="headerlink" title="制作"></a>制作</h2><p>新建参考：<a href="https://www.jianshu.com/p/3be3bfcdd62e" target="_blank" rel="noopener">https://www.jianshu.com/p/3be3bfcdd62e</a></p><p>结果</p><p><img src="http://image.joelyings.com/2020-02-06_1.png" alt></p><h2 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h2><p>将.ui的文件转换为.py的文件，cmd命令进入.ui文件所在目录下，运行以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyuic5 -o xxx.py xxx.ui</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/weixin_41929524/article/details/81456308" target="_blank" rel="noopener">Python制作小软件——1. 安装并使用PyQt5进行界面设计</a><br><a href="https://www.cnblogs.com/chen0307/p/9844352.html" target="_blank" rel="noopener">python使用PyQt5，及QtCreator，qt-unified界面设计以及逻辑实现</a><br><a href="https://www.cnblogs.com/linyfeng/category/1546338.html" target="_blank" rel="noopener">随笔分类 - PyQt入门教程</a><br><a href="https://blog.csdn.net/weixin_41929524/article/details/81484806" target="_blank" rel="noopener">Python制作小软件——4. 利用PyInstaller打包成exe文件</a><br><a href="https://blog.csdn.net/bailang_zhizun/article/details/79310419" target="_blank" rel="noopener">Python - 编写可视化界面（Python+PyCharm+PyQt）</a><br><a href></a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://blog.joelyings.com/post/8d24b1e6.html#disqus_thread</comments>
    </item>
    
    <item>
      <title>Django搭建免费视频网站其二</title>
      <link>https://blog.joelyings.com/post/b15ef11a.html</link>
      <guid>https://blog.joelyings.com/post/b15ef11a.html</guid>
      <pubDate>Wed, 05 Feb 2020 14:27:25 GMT</pubDate>
      <description>
      
        易事，难事，风雨事，江湖事，王朝事，天下事，都不过一剑的事
      
      </description>
      
      <content:encoded><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><!-- build time:Wed Feb 26 2020 13:38:41 GMT+0800 (GMT+08:00) --><img class="joel-img" src="http://image.joelyings.com/2020-02-06_5.jpg"><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><a href="https://github.com/joelYing/LVideo" target="_blank" rel="noopener">代码传送门</a></p><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><h4 id="自定义tag"><a href="#自定义tag" class="headerlink" title="自定义tag"></a>自定义tag</h4><p>这是在练习Django时做的博客项目中用到的，在这里记录，目的是为了把评论功能做成一个即插即用的组件</p><p>用到了Django的template tag（自定义标签）的接口，使得在任何需要添加评论的地方，只要使用</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">comment_block</span> request.path %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>即可，之所以叫comment_block，是因为comment是Django的内置tag，用来做大块代码的注释，类似for循环和if判断，这些都是内置的，所以我们需要自定义一个tag</p><p>在commentAPP下新建templatetags目录，同时新增<code>__init__.py</code>与<code>comment_block.py</code>文件</p><p>在<code>comment_block.py</code>中编写自定义标签的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> comment.forms <span class="keyword">import</span> CommentForm</span><br><span class="line"><span class="keyword">from</span> comment.models <span class="keyword">import</span> Comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@register.inclusion_tag('comment/block.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment_block</span><span class="params">(target)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">'target'</span>: target,               <span class="comment"># 评论目标博文的url</span></span><br><span class="line">        <span class="string">'comment_form'</span>: CommentForm(),  <span class="comment"># 评论表单</span></span><br><span class="line">        <span class="string">'comment_list'</span>: Comment.get_by_target(target),  <span class="comment"># 根据博文路径获取的博文下的评论</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>方法会返回以上的内容，包括target(目标文章)，comment_form(评论表单的样式)，comment_list(根据target得到的评论的list)，去渲染 comment/block.html 模板文件</p><figure class="highlight html"><figcaption><span>comment/block.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-group"</span> <span class="attr">action</span>=<span class="string">"/comment/"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"target"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; target &#125;&#125;"</span>&gt;</span></span><br><span class="line">        &#123;&#123; comment_form &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"写好了"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 评论列表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></span><br><span class="line">        &#123;% for comment in comment_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"nickname"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; comment.website &#125;&#125;"</span>&gt;</span>&#123;&#123; comment.nickname &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; comment.created_time &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"comment-content"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 关闭Django模板自动转码功能 ，如不关怎会出现页面上的评论内容是这样的：&lt;p&gt;hahahahahhahahahahahhaha&lt;/p&gt; --&gt;</span></span><br><span class="line">                &#123;% autoescape off %&#125;</span><br><span class="line">                &#123;&#123; comment.content &#125;&#125;</span><br><span class="line">                &#123;% endautoescape %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将value的值<code>target</code>渲染好后，带上comment_form参数，文件中的form最后发送一个post请求到<code>/comment/</code>的路由，根据url.py中的路由规则，请求得到的闭包发送给CommentView</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    http_method_names = [<span class="string">'post'</span>]</span><br><span class="line">    template_name = <span class="string">'comment/result.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        comment_form = CommentForm(request.POST)</span><br><span class="line">        target = request.POST.get(<span class="string">'target'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> comment_form.is_valid():</span><br><span class="line">            instance = comment_form.save(commit=<span class="literal">False</span>)</span><br><span class="line">            instance.target = target</span><br><span class="line">            instance.save()</span><br><span class="line">            succeed = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> redirect(target)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            succeed = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">'succeed'</span>: succeed,</span><br><span class="line">            <span class="string">'form'</span>: comment_form,</span><br><span class="line">            <span class="string">'target'</span>: target,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> self.render_to_response(context)</span><br></pre></td></tr></table></figure><p>在CommentView中的post方法接收这些参数，验证comment_form，并保存数据到instance，存到数据库中，成功后返回</p><p>在博文详情页面加上评论功能：</p><figure class="highlight html"><figcaption><span>detail.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "./base.html" %&#125;</span><br><span class="line"><span class="comment">&lt;!-- 加载自定义的标签 --&gt;</span></span><br><span class="line">&#123;% load comment_block %&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;% block main %&#125;</span><br><span class="line">&#123;% if post %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; post.title &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>分类：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'category-list' post.category_id %&#125;"</span>&gt;</span>&#123;&#123; post.category.name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>作者：<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'author' post.owner.id %&#125;"</span>&gt;</span>&#123;&#123; post.owner.username &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;% autoescape off %&#125;</span><br><span class="line">    &#123;&#123; post.content_html &#125;&#125;</span><br><span class="line">    &#123;% endautoescape %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用标签，传入参数request.path，即target --&gt;</span></span><br><span class="line">&#123;% comment_block request.path %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>Django模板中可以使用<code>request</code>参数，<code>request.path</code>就是当前博文页面的url，将其作为参数传递给自定义的<code>comment_block</code>标签的方法，此时<code>def comment_block(target)</code>中传入的target参数就是<code>request.path</code></p><p>评论表单提交的流程：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">1. 在文章页面下方的表单中(detail.html)页面中，加载</span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> comment_block %&#125;</span><span class="xml"> comment_block标签</span></span><br><span class="line"><span class="xml">2. 引用的时候，</span><span class="template-tag">&#123;% <span class="name">comment_block</span> request.path %&#125;</span><span class="xml">，传入参数request.path，即当前文章所在的url</span></span><br><span class="line"><span class="xml">3. 在comment_block.py中定义了方法，需要传入的参数为target，这样做就使得 target=request.path</span></span><br></pre></td></tr></table></figure><blockquote><p>用户填写评论，提交表单 -&gt; CommentForm处理表单 -&gt; 验证通过 -&gt; 保存数据到instance -&gt; instance.save方法把数据保存到数据库 -&gt; 用户刷新页面 -&gt; 通过comment_block模板自定义标签获取并展示数据</p><footer><strong>Django企业开发实战</strong><cite>胡阳</cite></footer></blockquote><h4 id="spaceless"><a href="#spaceless" class="headerlink" title="spaceless"></a>spaceless</h4><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">spaceless</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>标签的作用是 去除Django模板因使用for循环而产生的很多空行</p><h4 id="autoescape"><a href="#autoescape" class="headerlink" title="autoescape"></a>autoescape</h4><p>作用是关闭Django模板的自动转码功能</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% autoescape off %&#125;</span><br><span class="line">&#123;&#123; post.content_html &#125;&#125;</span><br><span class="line">&#123;% endautoescape %&#125;</span><br></pre></td></tr></table></figure><h4 id="forloop"><a href="#forloop" class="headerlink" title="forloop"></a>forloop</h4><p><a href="https://www.cnblogs.com/chenkeven/articles/9340961.html" target="_blank" rel="noopener">django forloop添加序号和增加一对多数据示例</a></p><h4 id="title属性"><a href="#title属性" class="headerlink" title="title属性"></a>title属性</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rank_text_name"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span>&#123;&#123; video.name &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为<code>span</code>添加<code>title</code>属性，鼠标移到元素上时显示title中的内容</p><p>避免用户看不到某些视频名称过长而因truncate缩减，导致看不见视频全称的情况</p><h4 id="remark"><a href="#remark" class="headerlink" title="remark"></a>remark</h4><p><a href="https://www.cnblogs.com/Jack1ee/p/5426757.html" target="_blank" rel="noopener">参考这篇</a></p><p>具体内容：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、首先当然是要插入一张图片啦，</span><br><span class="line">代码如下：&lt;<span class="selector-tag">a</span> href=<span class="string">"#"</span> target=<span class="string">"_blank"</span>&gt;&lt;<span class="selector-tag">img</span> src=<span class="string">"images/13.png"</span> <span class="attribute">width</span>=<span class="string">"240"</span> heigth=<span class="string">"240"</span>&gt;&lt;/a&gt;</span><br><span class="line">图片路径自己定义。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、定义一个层在图片上。这里要用到定位。<span class="attribute">position</span>。</span><br><span class="line">&lt;<span class="selector-tag">div</span> class=<span class="string">"con_img"</span>&gt;&lt;<span class="selector-tag">img</span> src=<span class="string">""</span>&gt;&lt;<span class="selector-tag">span</span> class=<span class="string">"ms"</span>&gt;&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">.con_img&#123;<span class="attribute">position</span>: relative; <span class="attribute">width</span>: <span class="number">240px</span>; <span class="attribute">height</span>: <span class="number">240px</span>;&#125;</span><br><span class="line">.ms&#123;<span class="attribute">position</span>: absolute; <span class="attribute">bottom</span>: <span class="number">0</span>;<span class="attribute">left</span>: <span class="number">0</span>; <span class="attribute">width</span>: <span class="number">240px</span>; <span class="attribute">height</span>: <span class="number">25px</span>; <span class="attribute">background</span>: <span class="number">#000</span>;&#125;</span><br></pre></td></tr></table></figure><p>修改如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"cover_img_span3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;% url 'video-detail' video.id %&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"cover_remark"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.remark &#125;&#125;"</span>&gt;</span>&#123;&#123; video.remark &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"180px"</span> <span class="attr">height</span>=<span class="string">"236px"</span> <span class="attr">class</span>=<span class="string">"type-list-card-img"</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; video.cover_url &#125;&#125;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; video.name &#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为视频封面右下角添加remark备注</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">css</span>部分</span><br><span class="line"><span class="selector-class">.cover_img_span3</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">194px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">250px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">span</span><span class="selector-class">.cover_remark</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: normal;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.9em</span>;</span><br><span class="line">    <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">    <span class="attribute">text-align</span>: right;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(0,0,0,0.65);</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span><br><span class="line">    <span class="comment">/* border: 0.5px solid rgba(0.1,0.1,0.1,0.5); */</span></span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">2.5px</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="解析接口"><a href="#解析接口" class="headerlink" title="解析接口"></a>解析接口</h4><p>解析接口页面模板主要部分：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "video/base.html" %&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#123;% block main %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"vip-logo"</span>&gt;</span>VIP视频在线解析<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"parse-search"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"str-post"</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">'&#123;% url '</span><span class="attr">vip-parse</span>' %&#125;'&gt;</span></span><br><span class="line">            &#123;% csrf_token %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input-url"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">placeholder</span>=<span class="string">"请输入播放地址后解析,支持爱奇艺,优酷,土豆等VIP视频播放地址"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-group-append"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"path"</span> <span class="attr">style</span>=<span class="string">"width: 200px"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"p-selected"</span>&gt;</span></span><br><span class="line">                      &#123;% for parse_interface in parse_interfaces %&#125;</span><br><span class="line">                          <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; parse_interface.parse_url &#125;&#125;"</span>&gt;</span>&#123;&#123; parse_interface.name &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                      &#123;% endfor %&#125;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-auto"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary mb-2"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://image.joelyings.com/2020-01-11-8.gif"</span> <span class="attr">height</span>=<span class="string">"548px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">id</span>=<span class="string">"player"</span> <span class="attr">scrolling</span>=<span class="string">"no"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $(<span class="string">"html,body"</span>).animate(&#123;</span></span><br><span class="line"><span class="javascript">                scrollTop: $(<span class="string">".parse-search"</span>).offset().top</span></span><br><span class="line">            &#125;, 200);</span><br><span class="line"><span class="javascript">            $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, <span class="built_in">document</span>.getElementById(<span class="string">"p-selected"</span>).value + $(<span class="string">"#input-url"</span>).val());</span></span><br><span class="line"><span class="javascript">            $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><p>添加了一个select下拉按钮，里面包含从数据库取出来的解析接口url及名称：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"p-selected"</span>&gt;</span></span><br><span class="line">  &#123;% for parse_interface in parse_interfaces %&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; parse_interface.parse_url &#125;&#125;"</span>&gt;</span>&#123;&#123; parse_interface.name &#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为提交解析的按钮<code>Submit</code>添加<a href="https://www.w3school.com.cn/jquery/event_submit.asp" target="_blank" rel="noopener">jQuery事件</a>，将接口与待解析的链接<a href="http://tool.liumingye.cn/video/js/video.js?0122" target="_blank" rel="noopener">拼接</a>起来</p><p>参考：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"html,body"</span>).animate(&#123;</span><br><span class="line">        scrollTop: $(<span class="string">".search"</span>).offset().top</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, $(<span class="string">".am-selected"</span>).find(<span class="string">'.am-checked'</span>).data(<span class="string">'value'</span>) + $(<span class="string">"#str-post"</span>).serializeArray()[<span class="number">0</span>].value);</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>修改后：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"str-post"</span> <span class="attr">class</span>=<span class="string">"input-group"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">'&#123;% url '</span><span class="attr">vip-parse</span>' %&#125;'&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary mb-2"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">src</span>=<span class="string">"http://image.joelyings.com/2020-01-11-8.gif"</span> <span class="attr">height</span>=<span class="string">"548px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">id</span>=<span class="string">"player"</span> <span class="attr">scrolling</span>=<span class="string">"no"</span> <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="comment">// 为id为str-post的表单添加</span></span><br><span class="line">    $(<span class="string">"#str-post"</span>).submit(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">"html,body"</span>).animate(&#123;</span><br><span class="line">        scrollTop: $(<span class="string">".parse-search"</span>).offset().top</span><br><span class="line">    &#125;, <span class="number">200</span>);</span><br><span class="line">    <span class="comment">// 为iframe修改播放源</span></span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"src"</span>, <span class="built_in">document</span>.getElementById(<span class="string">"p-selected"</span>).value + $(<span class="string">"#input-url"</span>).val());</span><br><span class="line">    $(<span class="string">'#player'</span>).attr(<span class="string">"style"</span>,<span class="string">"height: 548px!important;"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><h4 id="datetimefield"><a href="#datetimefield" class="headerlink" title="datetimefield"></a>datetimefield</h4><p>Django中模型的时间字段定义为datetimefield时，爬虫向这个字段插入同样时间格式的str数据时，可以成功</p><p><a href="https://www.jb51.net/article/155630.htm" target="_blank" rel="noopener">如何在Django中添加没有微秒的 DateTimeField 属性详解</a></p><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><h4 id="多个视频类型共用一个视图逻辑"><a href="#多个视频类型共用一个视图逻辑" class="headerlink" title="多个视频类型共用一个视图逻辑"></a>多个视频类型共用一个视图逻辑</h4><p>每个分类的<code>更多</code>页面通过获取请求的url路径最后部分，根据models中对应的类型，通过一个view进行获取不同类型的queryset，这样就不用每一个<code>更多</code>页面都写一个模板，可以共用一个模板，只是传入的queryset会根据请求路径的不同而不同</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型部分</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    TYPE_DM, TYPE_MV, TYPE_TV, TYPE_ZY, TYPE_OT = <span class="string">'动漫'</span>, <span class="string">'电影'</span>, <span class="string">'电视剧'</span>, <span class="string">'综艺'</span>, <span class="string">'其他'</span></span><br><span class="line">    V_TYPE_LIST = &#123;</span><br><span class="line">        <span class="string">'dm'</span>: TYPE_DM,</span><br><span class="line">        <span class="string">'mv'</span>: TYPE_MV,</span><br><span class="line">        <span class="string">'tv'</span>: TYPE_TV,</span><br><span class="line">        <span class="string">'zy'</span>: TYPE_ZY,</span><br><span class="line">        <span class="string">'ot'</span>: TYPE_OT</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># '更多页面'视图</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoreListView</span><span class="params">(CommonListView)</span>:</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br><span class="line">    template_name = <span class="string">'video/more_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data()</span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="comment"># 传入导航菜单对应视频类型的菜单名称</span></span><br><span class="line">            <span class="string">'button'</span>: VideoInfo.V_TYPE_LIST[str(self.request.path).replace(<span class="string">'/'</span>, <span class="string">''</span>)],</span><br><span class="line">            <span class="string">'links'</span>: Links.get_links(),</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 获取请求的路径</span></span><br><span class="line">        request_path = str(self.request.path).replace(<span class="string">'/'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="comment"># 根据模型层定义的字典获取对应的视频类型</span></span><br><span class="line">        v_type = VideoInfo.V_TYPE_LIST[request_path]</span><br><span class="line">        <span class="comment"># 通过模型层的方法获取对应视频类型的信息queryset，并去模板中渲染</span></span><br><span class="line">        queryset = VideoInfo.get_type_video_list(v_type)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br></pre></td></tr></table></figure><h3 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h3><h4 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h4><p><a href="https://v4.bootcss.com/docs/4.3/content/typography/#text-utilities" target="_blank" rel="noopener">text-utilities</a></p><p>对于较长的文本内容，可以通过添加 .text-truncate 类将文本截断并添加省略号。 元素必须是 display: inline-block 或 display: block 类型</p><p><a href="https://v4.bootcss.com/docs/4.3/content/typography/#inline" target="_blank" rel="noopener">inline</a></p><p>在同一行 Remove a list’s bullets and apply some light margin with a combination of two classes, .list-inline and .list-inline-item.</p><p><a href="https://v4.bootcss.com/docs/4.3/utilities/text/#%E6%96%87%E6%9C%AC%E5%AF%B9%E9%BD%90" target="_blank" rel="noopener">文本对齐</a></p><p>使用文本对齐类可以轻松地将文本重新对齐到组件</p><p><a href="https://v4.bootcss.com/docs/4.3/utilities/spacing/" target="_blank" rel="noopener">间距</a></p><p>控制视频封面间距</p><p><a href="https://www.jianshu.com/p/37f6622adb2d" target="_blank" rel="noopener">bootstrap导航条</a></p><p>也就是ul标签中所有a标签的href属性都失效了，后来也是一顿搜索，发现，bootstrap把href属性当id处理，只链接到当前页面的位置，而外部跳转链接被屏蔽</p><h3 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h3><h4 id="在两个site中注册APP"><a href="#在两个site中注册APP" class="headerlink" title="在两个site中注册APP"></a>在两个site中注册APP</h4><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@admin</span>.register(Post, site=custom_site) # custom_site</span><br><span class="line"><span class="variable">@admin</span>.register(Post)                   # 默认的site</span><br><span class="line">class PostAdmin(BaseOwnerAdmin):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h3 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h3><h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p><a href="https://blog.csdn.net/LingHuChong20/article/details/103017114" target="_blank" rel="noopener">Django 分页 , 只显示最近的几页( 只显示靠近的几页 )</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block paginate %&#125;</span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% for i in page_obj.paginator.page_range %&#125;</span><br><span class="line">                &#123;% if page_obj.number == i %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item active"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span>  <span class="attr">class</span>=<span class="string">"page-link"</span> &gt;</span>&#123;&#123; i &#125;&#125; <span class="tag">&lt;<span class="name">span</span>  <span class="attr">class</span>=<span class="string">"sr-only page-link"</span>&gt;</span>(current)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;%  elif  page_obj.number|add:max_left_item_count &gt;= i and  i|add:max_left_item_count  &gt;= page_obj.number  %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; i &#125;&#125;"</span>&gt;</span>&#123;&#123; i &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">            &#123;% if page_obj.has_next %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.next_page_number &#125;&#125;"</span>&gt;</span>&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% if  page_obj.paginator.num_pages &gt;  page_obj.number|add:max_left_item_count  %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.paginator.num_pages &#125;&#125;"</span>&gt;</span>&amp;raquo;&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">" page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.paginator.num_pages &#125;&#125;"</span>&gt;</span>&amp;raquo;&amp;raquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><h4 id="Scrapy连接池"><a href="#Scrapy连接池" class="headerlink" title="Scrapy连接池"></a>Scrapy连接池</h4><p>连接池的作用：</p><p>异步调用<code>do_insert</code>函数，dbpool会选择连接池中的一个连接对象在独立线程中调用<code>insert_db</code>，其中参数item会被传给<code>do_insert</code>的第二个参数，传给<code>do_insert</code>的第一个参数是一个Transaction对象，其接口与Cursor对象类似，可以调用execute方法执行SQL语句，<code>do_insert</code>执行后，连接对象会自动调用commit方法</p><h4 id="pv-uv"><a href="#pv-uv" class="headerlink" title="pv/uv"></a>pv/uv</h4><p>Django的models中添加了pv\uv这两个字段，默认为1，但是运行爬虫时，若没有数据存入这两个字段则会报错，因为其默认是不为空的，将数据库中原本的默认值改为null倒是可以继续爬虫了；</p><p>而为爬虫添加pv uv默认为1的值，存入数据库也没问题，后续两个值的增加也不会对更新语句有反应</p><h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><div class="note danger no-icon"><p>Reverse for 'xxx' with arguments '('',)' not found. 1 pattern(s) tried: ['Category/(?P<category_id>\d+)$']</category_id></p></div><p>主要原因：</p><p>urls里面设置参数的匹配正则是<code>&#39;category/&lt;int:category_id&gt;&#39;</code>，在html文件中做反向解析的时候又没有参数传递过去</p><p>url配置：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path('category/&lt;<span class="built_in">int</span>:category_id&gt;', <span class="module-access"><span class="module"><span class="identifier">CategoryView</span>.</span></span><span class="keyword">as</span><span class="constructor">_view()</span>, name='category-<span class="built_in">list</span>'),</span><br></pre></td></tr></table></figure><p>最后发现是在具体的list.html以及detail.html的文件中给分类标签，虽然加上了</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> 'category-list' cate.id %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>但是cate并不是循环中的值，没有类似以下循环</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> cate <span class="keyword">in</span> navs %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">...</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>GET /static/css/bootstrap.css HTTP/1.1 404 1789</p></div><p>原因：</p><p>没有加载static中的css资源，css路径：myblog/themes/bootstrap/static/css/bootstrap.css</p><p>正确操作：</p><p>THEME的值是前面settings.py中定义的’bootstrap’，将<code>templates</code>改为<code>static</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATIC_ROOT = <span class="string">'tmp/static'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os<span class="selector-class">.path</span><span class="selector-class">.join</span>(BASE_DIR, <span class="string">'themes'</span>, THEME, <span class="string">'static'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>之前是templates 所以找不到static文件夹</p><p>然后在模板中加上</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"&#123;% static 'css/bootstrap.css' %&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>即可</p><hr><div class="note danger no-icon"><p>AssertionError: Cannot filter a query once a slice has been taken</p></div><p>问题：获取切片后的数据集无法再进行筛选查询！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VideoDetailView(DetailView):</span><br><span class="line">    queryset = VideoInfo.latest_video()</span><br><span class="line">    ...</span><br><span class="line">    pk_url_kwarg = <span class="string">'video_id'</span></span><br></pre></td></tr></table></figure><p><code>latest_video()</code>方法部分如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryset = cls.objects.all().order_by(<span class="string">'-update_time'</span>)[:<span class="number">300</span>]</span><br></pre></td></tr></table></figure><p><code>[:300]</code>进行了切片，相当于已经经过了一次filter，而重写的<code>pk_url_kwarg</code>相当于DetailView的<code>get_object()</code>方法，</p><p>通过指定的参数<code>video_id</code>来filter上面的queryset数据集，而问题就在于已经切片过的数据集不能再进行筛选，所以后来修改</p><p><code>latest_video()</code>方法如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queryset = cls.objects.all().order_by(<span class="string">'-update_time'</span>)</span><br></pre></td></tr></table></figure><p>不在模型层对其进行切片操作，可以把切片放在视图层</p><hr><div class="note danger no-icon"><p>搜索关键词得不到相关视频时，出现的页面底部存在空白</p></div><p>修改如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if video_list %&#125;</span><br><span class="line">    &#123;% for video in video_list %&#125;</span><br><span class="line">    ...</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    # 若搜索关键词找不到相关视频</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"none-videolist"</span> <span class="attr">style</span>=<span class="string">"height: 100%;background-color: #202020;block-size: 1000px;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"h5"</span> <span class="attr">style</span>=<span class="string">"text-align: center;"</span>&gt;</span>未找到视频资源<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>条件检索后点击下一页查询条件丢失</p></div><p>情况跟<a href="https://blog.csdn.net/qq_42219101/article/details/96967243" target="_blank" rel="noopener">这个</a>大致相似：</p><p>在执行完搜索之后，然后到搜索结果的下一页的时候，会出现搜索的结果消失，只在地址栏中留下了，而没有关键词</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 正常情况</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/search?keyword=三生&amp;page=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"># 现在的问题</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/search/?page=<span class="number">2</span></span><br></pre></td></tr></table></figure><p>搜索的结果全部消失</p><p>解决换页搜索失效还可以<a href="https://blog.csdn.net/secowo/article/details/99685726" target="_blank" rel="noopener">通过JavaScript获取当前路径参数</a></p><p>但是最后还是通过修改<code>search_pagination.html</code>，在跳转页码的时候需要把搜索条件拼接到跳转页码的href上</p><figure class="highlight html"><figcaption><span>video/pagination.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 没有通过关键词搜索情况下的分页</span><br><span class="line"></span><br><span class="line">&#123;% block paginate %&#125;</span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            ...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>video/search_pagination.html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 关键词搜索后的分页，区别在于 href="?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span><br><span class="line"></span><br><span class="line">&#123;% if is_paginated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation "</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination  justify-content-center"</span>&gt;</span></span><br><span class="line">            &#123;% if page_obj.has_previous %&#125;</span><br><span class="line">                &#123;% if page_obj.number &gt;= max_left_item_count|add:max_left_item_count %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>  <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=&#123;&#123; page_obj.previous_page_number &#125;&#125;"</span>&gt;</span>&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"page-item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"page-link"</span> <span class="attr">href</span>=<span class="string">"?keyword=&#123;&#123; keyword &#125;&#125;&amp;page=1"</span>&gt;</span>&amp;laquo;&amp;laquo;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            ...</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>判断是否有关键词在上下文中：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if keyword %&#125;</span><br><span class="line">    &#123;% include "video/search_pagination.html" %&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    &#123;% include "video/pagination.html" %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><p>搜索视图的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SearchView</span><span class="params">(CommonListView)</span>:</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br><span class="line">    template_name = <span class="string">'video/more_list.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        context = super().get_context_data()</span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="string">'keyword'</span>: self.request.GET.get(<span class="string">'keyword'</span>, <span class="string">''</span>),</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        queryset = super().get_queryset()</span><br><span class="line">        keyword = self.request.GET.get(<span class="string">'keyword'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> keyword:</span><br><span class="line">            <span class="keyword">return</span> queryset</span><br><span class="line">        <span class="keyword">return</span> queryset.filter(Q(name__icontains=keyword) | Q(alias__icontains=keyword))</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>UnorderedObjectListWarning: Pagination may yield inconsistent results with an unordered object_list: xxx QuerySet.</p></div><p>经过搜索是由于： 所得的数据是无效的，故而分页出现错误</p><p>修改方法，在获得的数据之后对所得的数据进行排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lists = Article.objects.filter(</span><br><span class="line">        Q(title__icontains=word) | Q(context__icontains=word)).order_by(<span class="string">'-created_time'</span>)</span><br></pre></td></tr></table></figure><hr><div class="note danger"><p>封面链接是否有效需要在爬虫中就处理完毕，若失效则添加失效的封面链接代替</p></div><hr><div class="note danger no-icon"><p>models文件没什么问题，APP也都注册了，但就是出现No changes detected</p></div><p>models文件没什么问题，APP也都注册了，但修改models文件后再进行<code>makemigrations</code>，就是出现No changes detected</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(LVideo) E:\LVideo&gt;python3 manage.py makemigrations</span><br><span class="line">No changes detected</span><br></pre></td></tr></table></figure><p>于是一个个APP注册，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(LVideo) E:\LVideo&gt;python3 manage.py makemigrations video</span><br><span class="line">Migrations <span class="keyword">for</span> <span class="string">'video'</span>:</span><br><span class="line">  video\migrations\0001_initial.py</span><br><span class="line">    - Create model Source</span><br><span class="line">    - Create model VideoInfo</span><br><span class="line">    - Create model VideoLink</span><br><span class="line">    - Create model VideoPU</span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>遇到视频信息中包含韩文的问题</p></div><p>默认爬虫会保存韩文的<code>HTML实体编码 entity code</code>，类似<code>&amp;#44608;&amp;#45824;&amp;#49457;</code>的编码，而不是保存为韩文字</p><p>为了避免这种情况，需要通过Python的html库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content = html.unescape(html_entity)</span><br></pre></td></tr></table></figure><p>保证将要存入的内容转换后再存入数据库</p><hr><div class="note danger no-icon"><p>ajax的post请求，出现Forbidden (CSRF token missing or incorrect.)</p></div><p>ajax 的post请求,Forbidden (CSRF token missing or incorrect.)错误<a href="https://blog.csdn.net/weixin_43790705/article/details/87867172" target="_blank" rel="noopener">解决办法</a>：</p><p>在data中添加<code>csrfmiddlewaretoken</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    ...</span><br><span class="line">    data:&#123;</span><br><span class="line">        <span class="string">"csrfmiddlewaretoken"</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>或者，参考<a href="https://blog.csdn.net/qq_36963372/article/details/82713044" target="_blank" rel="noopener">这篇</a></p><p>注意是val()</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 这里添加token</span></span><br><span class="line">    <span class="keyword">var</span> token = $(<span class="string">'input[name=csrfmiddlewaretoken]'</span>).val();</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">         ...</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">'&#123;% url '</span><span class="string">' %&#125;'</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            <span class="comment">// 这里加上</span></span><br><span class="line">            data: &#123;<span class="attr">csrfmiddlewaretoken</span>: token&#125;,</span><br><span class="line">            dataType: <span class="string">'json'</span>,</span><br><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><hr><div class="note danger no-icon"><p>补充Hexo的一个问题：Nunjucks Error: [Line 35, Column 13] unknown block tag: xxx</p></div><p>在提交有</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">xxx</span> %&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>这种格式的文本时，一定要包上三个<code>点号</code>，两边只包上一个点号，会导致报错</p><h3 id="备选"><a href="#备选" class="headerlink" title="备选"></a>备选</h3><h4 id="播放器"><a href="#播放器" class="headerlink" title="播放器"></a>播放器</h4><p><a href="https://github.com/videojs/video.js" target="_blank" rel="noopener">videojs</a><br><a href="https://github.com/sampotts/plyr" target="_blank" rel="noopener">plyr</a><br><a href="https://github.com/bilibili/flv.js" target="_blank" rel="noopener">flv.js</a><br><a href="https://www.iaodun.com/faq/technical/2502.html" target="_blank" rel="noopener">用JW Player,ckplayer,Smartideo搭建视频直播站-支持各大视频网站和rtmp</a></p><!-- rebuild by neat -->]]></content:encoded>
      
      <comments>https://blog.joelyings.com/post/b15ef11a.html#disqus_thread</comments>
    </item>
    
  </channel>
</rss>
